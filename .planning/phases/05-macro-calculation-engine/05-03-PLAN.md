---
phase: 05-macro-calculation-engine
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/lib/nutrition/tdee.ts
  - src/lib/nutrition/macro-targets.ts
  - src/lib/nutrition/index.ts
  - src/lib/nutrition/__tests__/tdee.test.ts
  - src/lib/nutrition/__tests__/macro-targets.test.ts
autonomous: true

must_haves:
  truths:
    - "calculateTDEE produces correct TDEE using hybrid approach (base activity multiplier + MET sport addition)"
    - "Sport calories are spread evenly across 7 days (weekly average model)"
    - "MET calculation subtracts 1 MET to avoid double-counting resting component"
    - "calculateMacroTargets applies goal-based calorie adjustment before splitting macros"
    - "Protein is calculated from g/kg body weight, not flat percentage"
    - "Carbs fill remaining calories after protein and fat"
    - "Safety check ensures minimum 50g carbs by reducing fat if needed"
  artifacts:
    - path: "src/lib/nutrition/tdee.ts"
      provides: "TDEE calculation with sport adjustment"
      exports: ["calculateTDEE"]
    - path: "src/lib/nutrition/macro-targets.ts"
      provides: "Daily macro targets per goal"
      exports: ["calculateMacroTargets"]
    - path: "src/lib/nutrition/index.ts"
      provides: "Public API re-exports"
      exports: ["calculateBMR", "calculateTDEE", "calculateMacroTargets", "calculateRecipeMacros", "convertToGrams"]
    - path: "src/lib/nutrition/__tests__/tdee.test.ts"
      provides: "TDEE unit tests"
      min_lines: 60
    - path: "src/lib/nutrition/__tests__/macro-targets.test.ts"
      provides: "Macro targets unit tests"
      min_lines: 60
  key_links:
    - from: "src/lib/nutrition/tdee.ts"
      to: "src/lib/nutrition/constants.ts"
      via: "imports activity multipliers, MET values, session durations"
      pattern: "import.*constants"
    - from: "src/lib/nutrition/macro-targets.ts"
      to: "src/lib/nutrition/constants.ts"
      via: "imports goal adjustments, protein/fat ratios, kcal per gram"
      pattern: "import.*constants"
    - from: "src/lib/nutrition/index.ts"
      to: "src/lib/nutrition/bmr.ts"
      via: "re-exports calculateBMR"
      pattern: "export.*from.*bmr"
---

<objective>
Build TDEE calculation (with sport adjustment) and macro targets derivation, then create the index.ts public API that re-exports the entire nutrition module.

Purpose: Completes the user-facing calculation chain: BMR -> TDEE -> MacroTargets. The TDEE uses a hybrid approach (lifestyle multiplier + MET sport addition) and the macro targets use evidence-based g/kg protein recommendations per goal.
Output: Two calculation modules with tests, plus the index.ts barrel export.
</objective>

<execution_context>
@/Users/jimmydore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jimmydore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-macro-calculation-engine/05-RESEARCH.md
@.planning/phases/05-macro-calculation-engine/05-01-SUMMARY.md

@src/lib/nutrition/types.ts
@src/lib/nutrition/constants.ts
@src/lib/nutrition/bmr.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TDEE calculation with tests</name>
  <files>
    src/lib/nutrition/tdee.ts
    src/lib/nutrition/__tests__/tdee.test.ts
  </files>
  <action>
Create `src/lib/nutrition/tdee.ts`:

```typescript
export function calculateTDEE(
  bmrResult: BMRResult,
  profile: Pick<UserProfile, "weight" | "activityLevel">,
  sportSessions: SportSession[],
): TDEEResult
```

Implementation:
1. Get base activity multiplier from BASE_ACTIVITY_MULTIPLIERS[profile.activityLevel]
2. activityTDEE = bmr * multiplier
3. For each sport session: calculate net calories = (MET - 1) * weight * duration_hours * weeklyFrequency
   - Subtract 1 from MET to avoid double-counting the resting component already captured in activityTDEE
4. Sum all sport calories for the week, divide by 7 for daily average
5. Final TDEE = activityTDEE + dailySportCalories
6. Round all output values to nearest integer

Import types from `./types` and constants from `./constants`.

Create `src/lib/nutrition/__tests__/tdee.test.ts`:

**Sedentary, no sport:**
- BMR 1780, sedentaire, 80kg, no sport sessions
- activityTDEE = 1780 * 1.2 = 2136
- sportCalories = 0
- tdee = 2136

**Active with sport sessions:**
- BMR 1780, legerement_actif (1.3), 80kg
- Sport: course 3x/week, musculation 2x/week
  - Course: (9.0 - 1) * 80 * 1.0 * 3 = 1920 kcal/week
  - Musculation: (5.0 - 1) * 80 * 1.0 * 2 = 640 kcal/week
  - Total weekly: 2560, daily: 2560/7 = ~366
- activityTDEE = 1780 * 1.3 = 2314
- tdee = 2314 + 366 = 2680 (verify exact rounding)

**No sport sessions (empty array):**
- sportCalories should be 0

**Single sport, high frequency:**
- velo 5x/week, 80kg, BMR 1700, sedentaire
  - (7.0 - 1) * 80 * 1.5 * 5 = 3600 kcal/week, daily = 514
- Verify large sport contributions don't break anything

**All activity levels:**
- Same BMR, no sport, iterate through all 5 activity levels
- Verify sedentaire < legerement_actif < moderement_actif < actif < tres_actif

**Verify all values are rounded integers:**
- Check each field of TDEEResult with Number.isInteger()
  </action>
  <verify>Run `pnpm test src/lib/nutrition/__tests__/tdee.test.ts` -- all tests pass.</verify>
  <done>calculateTDEE correctly applies hybrid approach with MET-based sport addition, weekly averaging, and rounded integer outputs. All tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Create macro targets calculation with tests, plus index.ts</name>
  <files>
    src/lib/nutrition/macro-targets.ts
    src/lib/nutrition/__tests__/macro-targets.test.ts
    src/lib/nutrition/index.ts
  </files>
  <action>
Create `src/lib/nutrition/macro-targets.ts`:

```typescript
export function calculateMacroTargets(
  tdeeResult: TDEEResult,
  profile: Pick<UserProfile, "weight" | "goal">,
): MacroTargets
```

Implementation:
1. Apply goal calorie adjustment: targetCalories = tdee * (1 + GOAL_CALORIE_ADJUSTMENTS[goal])
2. Calculate protein: GOAL_PROTEIN_PER_KG[goal] * weight (in grams)
3. Calculate fat: (targetCalories * GOAL_FAT_PERCENTAGE[goal]) / KCAL_PER_GRAM.fat (in grams)
4. Calculate carbs: remaining calories / KCAL_PER_GRAM.carbs
   - remaining = targetCalories - (protein * 4) - (fat * 9)
5. Safety check: if carbs < MIN_CARBS_GRAMS (50g), reduce fat to make room:
   - carbDeficit = MIN_CARBS_GRAMS - carbs
   - caloriesToReallocate = carbDeficit * KCAL_PER_GRAM.carbs
   - fat -= caloriesToReallocate / KCAL_PER_GRAM.fat
   - carbs = MIN_CARBS_GRAMS
6. Round all values to nearest integer

Create `src/lib/nutrition/__tests__/macro-targets.test.ts`:

**Maintien, 80kg, TDEE 2500:**
- calories = 2500 * 1.0 = 2500
- protein = 1.4 * 80 = 112g (448 kcal)
- fat = (2500 * 0.30) / 9 = 83g (750 kcal -> 747 rounded)
- carbs = (2500 - 448 - 747) / 4 = 326g (verify exact rounding)

**Seche, 80kg, TDEE 2500:**
- calories = 2500 * 0.80 = 2000
- protein = 2.0 * 80 = 160g (640 kcal)
- fat = (2000 * 0.25) / 9 = 56g (500 kcal -> 504 rounded)
- carbs = (2000 - 640 - 504) / 4 = 214g

**Prise de masse, 80kg, TDEE 2500:**
- calories = 2500 * 1.10 = 2750
- protein = 1.8 * 80 = 144g
- fat = (2750 * 0.25) / 9 = 76g
- carbs = remainder

**Recomposition, 80kg, TDEE 2500:**
- calories = 2500 * 0.90 = 2250
- protein = 2.2 * 80 = 176g
- fat = (2250 * 0.25) / 9 = 63g
- carbs = remainder

**Safety check: minimum carbs trigger:**
- Create a scenario where carbs would be < 50g (e.g., very heavy person in a steep deficit)
- Example: 130kg person, seche, TDEE = 1500 (artificially low)
  - calories = 1200, protein = 2.0 * 130 = 260g (1040 kcal)
  - fat = 1200 * 0.25 / 9 = 33g (297 kcal)
  - carbs = (1200 - 1040 - 297) / 4 = -34g -> triggers safety
  - fat reduced, carbs set to 50g
- Verify carbs never goes below 50

**All values are rounded integers:**
- Check each field of MacroTargets with Number.isInteger()

**All four goals produce different results:**
- Same profile/TDEE, iterate through all 4 goals
- Verify each produces different calorie targets

Create `src/lib/nutrition/index.ts`:

Re-export the public API:
```typescript
export { calculateBMR } from "./bmr";
export { calculateTDEE } from "./tdee";
export { calculateMacroTargets } from "./macro-targets";
export { calculateRecipeMacros } from "./recipe-macros";
export { convertToGrams } from "./unit-conversion";
export type { UserProfile, SportSession, BMRResult, TDEEResult, MacroTargets, RecipeMacrosResult } from "./types";
```

This allows consumers to do `import { calculateBMR, calculateTDEE } from "@/lib/nutrition"`.
  </action>
  <verify>Run `pnpm test src/lib/nutrition/__tests__/macro-targets.test.ts` -- all tests pass. Run `pnpm exec tsc --noEmit` -- index.ts re-exports compile correctly.</verify>
  <done>calculateMacroTargets correctly derives daily P/G/L targets with goal adjustment and minimum carbs safety check. index.ts re-exports the full public API. All tests pass.</done>
</task>

</tasks>

<verification>
1. `pnpm exec tsc --noEmit` -- no type errors
2. `pnpm test src/lib/nutrition/` -- all nutrition tests pass (bmr, tdee, macro-targets, unit-conversion, recipe-macros)
3. `pnpm check` -- Biome formatting/linting passes
4. Import from `@/lib/nutrition` works: all 5 functions + 6 types available
</verification>

<success_criteria>
- calculateTDEE uses hybrid approach: base lifestyle multiplier + MET sport calories spread over 7 days
- Sport MET calculation subtracts 1 to avoid double-counting rest
- calculateMacroTargets uses g/kg protein (not flat %), with goal-based calorie adjustment
- Minimum 50g carbs safety check triggers when protein+fat exceed budget
- index.ts barrel exports the full nutrition module public API
- All tests pass with `pnpm test`
</success_criteria>

<output>
After completion, create `.planning/phases/05-macro-calculation-engine/05-03-SUMMARY.md`
</output>
