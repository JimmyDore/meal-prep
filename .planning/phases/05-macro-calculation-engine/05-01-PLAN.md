---
phase: 05-macro-calculation-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/nutrition/types.ts
  - src/lib/nutrition/constants.ts
  - src/lib/nutrition/bmr.ts
  - src/lib/nutrition/__tests__/bmr.test.ts
autonomous: true

must_haves:
  truths:
    - "calculateBMR returns correct BMR for male profiles using Mifflin-St Jeor formula"
    - "calculateBMR returns correct BMR for female profiles (subtracts 161 instead of adding 5)"
    - "All nutrition types are exported and usable by downstream modules"
    - "All nutrition constants (MET values, activity multipliers, macro ratios, calorie adjustments) are exported"
  artifacts:
    - path: "src/lib/nutrition/types.ts"
      provides: "Shared types for nutrition module"
      exports: ["UserProfile", "SportSession", "BMRResult", "TDEEResult", "MacroTargets", "RecipeMacrosResult"]
    - path: "src/lib/nutrition/constants.ts"
      provides: "All nutrition constants"
      exports: ["BASE_ACTIVITY_MULTIPLIERS", "SPORT_MET_VALUES", "DEFAULT_SESSION_DURATION_HOURS", "GOAL_CALORIE_ADJUSTMENTS", "GOAL_PROTEIN_PER_KG", "GOAL_FAT_PERCENTAGE", "KCAL_PER_GRAM", "MIN_CARBS_GRAMS"]
    - path: "src/lib/nutrition/bmr.ts"
      provides: "BMR calculation via Mifflin-St Jeor"
      exports: ["calculateBMR"]
    - path: "src/lib/nutrition/__tests__/bmr.test.ts"
      provides: "BMR unit tests"
      min_lines: 40
  key_links:
    - from: "src/lib/nutrition/bmr.ts"
      to: "src/lib/nutrition/types.ts"
      via: "imports UserProfile and BMRResult types"
      pattern: "import.*types"
---

<objective>
Create the foundation for the nutrition calculation module: shared types, constants, and BMR calculation with tests.

Purpose: Establishes the type system and constants that all other nutrition calculations depend on. BMR (Basal Metabolic Rate) is the first step in the TDEE calculation chain.
Output: Three source files (types.ts, constants.ts, bmr.ts) and one test file, all in src/lib/nutrition/
</objective>

<execution_context>
@/Users/jimmydore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jimmydore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-macro-calculation-engine/05-RESEARCH.md

@src/db/schema/profiles.ts
@src/db/schema/sport-activities.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create types.ts and constants.ts</name>
  <files>
    src/lib/nutrition/types.ts
    src/lib/nutrition/constants.ts
  </files>
  <action>
Create `src/lib/nutrition/types.ts` with these interfaces/types:

```typescript
// UserProfile - matches DB schema enums exactly
interface UserProfile {
  weight: number;       // kg
  height: number;       // cm
  age: number;          // years
  sex: "homme" | "femme";
  activityLevel: "sedentaire" | "legerement_actif" | "moderement_actif" | "actif" | "tres_actif";
  goal: "seche" | "maintien" | "prise_de_masse" | "recomposition";
}

interface SportSession {
  activityType: "course" | "musculation" | "natation" | "velo" | "yoga" | "marche" | "sport_collectif";
  weeklyFrequency: number;
}

interface BMRResult {
  bmr: number;  // kcal/day, rounded integer
}

interface TDEEResult {
  bmr: number;
  activityTDEE: number;
  sportCalories: number;
  tdee: number;
}

interface MacroTargets {
  calories: number;   // kcal/day
  protein: number;    // grams/day
  fat: number;        // grams/day
  carbs: number;      // grams/day
}

interface RecipeMacrosResult {
  perServing: { calories: number; protein: number; carbs: number; fat: number; };
  totalRecipe: { calories: number; protein: number; carbs: number; fat: number; };
  confidence: "high" | "medium" | "low";
  convertedCount: number;
  totalCount: number;
  missingIngredients: string[];
}
```

Export all types. Use `export interface` (not `export type`).

Create `src/lib/nutrition/constants.ts` with all constants from the research:

1. `BASE_ACTIVITY_MULTIPLIERS` - lifestyle NEAT only, sport excluded: sedentaire 1.2, legerement_actif 1.3, moderement_actif 1.4, actif 1.5, tres_actif 1.6
2. `SPORT_MET_VALUES` - from 2024 Compendium: course 9.0, musculation 5.0, natation 5.8, velo 7.0, yoga 2.5, marche 4.3, sport_collectif 7.5
3. `DEFAULT_SESSION_DURATION_HOURS` - course 1.0, musculation 1.0, natation 1.0, velo 1.5, yoga 1.0, marche 1.0, sport_collectif 1.5
4. `GOAL_CALORIE_ADJUSTMENTS` - seche -0.20, maintien 0, prise_de_masse +0.10, recomposition -0.10
5. `GOAL_PROTEIN_PER_KG` - seche 2.0, maintien 1.4, prise_de_masse 1.8, recomposition 2.2
6. `GOAL_FAT_PERCENTAGE` - seche 0.25, maintien 0.30, prise_de_masse 0.25, recomposition 0.25
7. `KCAL_PER_GRAM` - protein 4, carbs 4, fat 9
8. `MIN_CARBS_GRAMS` = 50

All constants should use `as const` for type narrowing. Add source comments (e.g., "Source: 2024 Adult Compendium of Physical Activities").
  </action>
  <verify>Run `pnpm exec tsc --noEmit` -- no type errors in the new files.</verify>
  <done>types.ts exports all 6 interfaces. constants.ts exports all 8 constants with correct values matching the research document.</done>
</task>

<task type="auto">
  <name>Task 2: Create BMR calculation with tests</name>
  <files>
    src/lib/nutrition/bmr.ts
    src/lib/nutrition/__tests__/bmr.test.ts
  </files>
  <action>
Create `src/lib/nutrition/bmr.ts`:

```typescript
export function calculateBMR(profile: Pick<UserProfile, "weight" | "height" | "age" | "sex">): BMRResult
```

Implement Mifflin-St Jeor equation:
- Men: BMR = (10 * weight) + (6.25 * height) - (5 * age) + 5
- Women: BMR = (10 * weight) + (6.25 * height) - (5 * age) - 161
- Round result to nearest integer with Math.round()

Import types from `./types`.

Create `src/lib/nutrition/__tests__/bmr.test.ts` with these test cases:

1. **Male standard case**: 80kg, 180cm, 30yo male -> BMR = 10*80 + 6.25*180 - 5*30 + 5 = 800 + 1125 - 150 + 5 = 1780
2. **Female standard case**: 60kg, 165cm, 25yo female -> BMR = 10*60 + 6.25*165 - 5*25 - 161 = 600 + 1031.25 - 125 - 161 = 1345 (rounded)
3. **Edge case: very light person**: 45kg, 150cm, 18yo female
4. **Edge case: heavy person**: 120kg, 195cm, 50yo male
5. **Edge case: elderly**: 70kg, 170cm, 80yo male -- verify BMR is still positive
6. **Rounding**: verify result is always an integer (use `Number.isInteger()`)
7. **Verify formula difference**: same profile but different sex should differ by exactly 166 (5 - (-161) = 166)

Use `describe("calculateBMR", () => { ... })` structure. Calculate expected values manually in comments.
  </action>
  <verify>Run `pnpm test src/lib/nutrition/__tests__/bmr.test.ts` -- all tests pass.</verify>
  <done>calculateBMR correctly implements Mifflin-St Jeor for both sexes. All 7+ test cases pass. BMR returns rounded integer.</done>
</task>

</tasks>

<verification>
1. `pnpm exec tsc --noEmit` -- no type errors
2. `pnpm test src/lib/nutrition/__tests__/bmr.test.ts` -- all tests pass
3. `pnpm check` -- Biome formatting/linting passes
</verification>

<success_criteria>
- types.ts exports UserProfile, SportSession, BMRResult, TDEEResult, MacroTargets, RecipeMacrosResult
- constants.ts exports all 8 constants with values matching 05-RESEARCH.md
- calculateBMR produces correct BMR for male and female profiles
- All tests pass with `pnpm test`
</success_criteria>

<output>
After completion, create `.planning/phases/05-macro-calculation-engine/05-01-SUMMARY.md`
</output>
