---
phase: 05-macro-calculation-engine
plan: 04
type: execute
wave: 3
depends_on: ["05-01", "05-02", "05-03"]
files_modified:
  - src/app/(authenticated)/dashboard/page.tsx
  - src/components/macro-dashboard.tsx
  - src/components/macro-detail.tsx
  - src/app/(authenticated)/recipes/[id]/page.tsx
autonomous: false

must_haves:
  truths:
    - "User sees their daily calorie target and P/G/L in grams on the dashboard"
    - "User can expand a detail view showing BMR, activity TDEE, sport calories, goal adjustment"
    - "TDEE is adjusted based on sport sessions stored in user profile"
    - "Recipe detail page shows computed macros per serving with confidence indicator"
    - "Recipes with missing ingredient data show appropriate confidence level (high/medium/low)"
  artifacts:
    - path: "src/app/(authenticated)/dashboard/page.tsx"
      provides: "Macro dashboard page"
      min_lines: 20
    - path: "src/components/macro-dashboard.tsx"
      provides: "Macro summary card component"
      min_lines: 40
    - path: "src/components/macro-detail.tsx"
      provides: "Expandable calculation detail view"
      min_lines: 30
    - path: "src/app/(authenticated)/recipes/[id]/page.tsx"
      provides: "Recipe detail with computed macros"
      contains: "calculateRecipeMacros"
  key_links:
    - from: "src/app/(authenticated)/dashboard/page.tsx"
      to: "src/lib/nutrition"
      via: "imports calculateBMR, calculateTDEE, calculateMacroTargets"
      pattern: "import.*from.*@/lib/nutrition"
    - from: "src/app/(authenticated)/dashboard/page.tsx"
      to: "src/db/queries/profiles.ts"
      via: "imports getFullUserProfile for user data"
      pattern: "import.*getFullUserProfile"
    - from: "src/app/(authenticated)/recipes/[id]/page.tsx"
      to: "src/lib/nutrition"
      via: "imports calculateRecipeMacros"
      pattern: "import.*calculateRecipeMacros"
---

<objective>
Build the macro dashboard page (showing TDEE + daily macro targets with expandable detail) and update the recipe detail page to show computed per-serving macros with confidence indicator.

Purpose: Makes the nutrition calculations visible to users. The dashboard shows personalized daily targets based on their profile, and the recipe detail shows real macros computed from ingredient data (replacing or complementing the Jow nutrition JSONB data).
Output: Dashboard page with macro summary card and detail view, updated recipe detail page with computed macros.
</objective>

<execution_context>
@/Users/jimmydore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jimmydore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-macro-calculation-engine/05-RESEARCH.md
@.planning/phases/05-macro-calculation-engine/05-01-SUMMARY.md
@.planning/phases/05-macro-calculation-engine/05-02-SUMMARY.md
@.planning/phases/05-macro-calculation-engine/05-03-SUMMARY.md

@src/lib/nutrition/index.ts
@src/lib/nutrition/types.ts
@src/app/(authenticated)/layout.tsx
@src/app/(authenticated)/settings/profile/page.tsx
@src/app/(authenticated)/recipes/[id]/page.tsx
@src/db/queries/profiles.ts
@src/db/queries/recipes.ts
@src/components/header.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create macro dashboard page with summary and detail components</name>
  <files>
    src/app/(authenticated)/dashboard/page.tsx
    src/components/macro-dashboard.tsx
    src/components/macro-detail.tsx
  </files>
  <action>
Create the macro dashboard as a server component page at `src/app/(authenticated)/dashboard/page.tsx`:

1. Get session via `auth.api.getSession({ headers: await headers() })` -- redirect to /auth if no session
2. Call `getFullUserProfile(session.user.id)` to get profile + sportActivities
3. If profile is incomplete (missing weight/height/age/sex/activityLevel/goal), show a message directing user to complete their profile at /settings/profile
4. Run calculation chain:
   - `calculateBMR({ weight, height, age, sex })`
   - `calculateTDEE(bmrResult, { weight, activityLevel }, sportActivities)`
   - `calculateMacroTargets(tdeeResult, { weight, goal })`
5. Pass results to client components for display
6. Add `metadata: { title: "Mes macros | Meal Prep" }`

Create `src/components/macro-dashboard.tsx` (client component for interactivity):

Summary card showing:
- Daily calories (large number, prominent)
- Three macro bars: Proteines Xg, Glucides Xg, Lipides Xg
- Use Tailwind: clean card with rounded borders, subtle shadow
- Color coding: protein blue, carbs amber/yellow, fat red/pink (or similar clear palette)
- Each macro shows grams and percentage of total calories: e.g., "160g (32%)"
- The card should be visually clean and minimal (per CONTEXT.md decision)

Create `src/components/macro-detail.tsx` (client component, expandable):

Expandable section ("Comment c'est calcule ?") that shows:
- BMR: {bmr} kcal/jour (Mifflin-St Jeor)
- Inputs: {weight}kg, {height}cm, {age} ans, {sex}
- Base TDEE: {activityTDEE} kcal (BMR x {multiplier} pour niveau "{activityLevel}")
- Sport: +{sportCalories} kcal/jour (from {N} activites)
  - List each sport: {type}: {frequency}x/sem = +{perSportDaily} kcal/jour
- TDEE total: {tdee} kcal/jour
- Objectif: {goal} -> {adjustment} -> {targetCalories} kcal/jour
- Repartition: P {protein}g, G {carbs}g, L {fat}g

Use a Collapsible component (shadcn/ui or simple useState toggle with chevron icon). The detail view uses a smaller font and muted colors to keep it secondary to the main summary card.

Props for macro-dashboard.tsx:
```typescript
interface MacroDashboardProps {
  macroTargets: MacroTargets;
  tdeeResult: TDEEResult;
  bmrResult: BMRResult;
  profile: { weight: number; height: number; age: number; sex: string; activityLevel: string; goal: string; };
  sportActivities: Array<{ activityType: string; weeklyFrequency: number; }>;
}
```

Add a link to the dashboard in the header navigation (next to "Mon profil"). Label: "Mes macros" or a chart icon.
  </action>
  <verify>Run `pnpm build` -- page builds without errors. Run `pnpm dev` and visit /dashboard -- verify the macro card renders with calculated values.</verify>
  <done>Dashboard page shows daily calorie target and P/G/L in grams. Expandable detail view shows full calculation chain (BMR, activity, sport, goal adjustment). Header has link to dashboard.</done>
</task>

<task type="auto">
  <name>Task 2: Update recipe detail page with computed macros per serving</name>
  <files>
    src/app/(authenticated)/recipes/[id]/page.tsx
  </files>
  <action>
Update the existing recipe detail page to show computed macros per serving:

1. Read the existing page implementation first
2. After fetching the recipe via `getRecipeById(id)`, call `calculateRecipeMacros()` with the recipe's ingredients and originalPortions:
   - Map `recipe.recipeIngredients` to `IngredientInput[]`:
     ```typescript
     const ingredientInputs = recipe.recipeIngredients.map(ri => ({
       name: ri.ingredient.name,
       quantity: ri.quantity,
       unit: ri.unit,
       caloriesPer100g: ri.ingredient.caloriesPer100g,
       proteinPer100g: ri.ingredient.proteinPer100g,
       carbsPer100g: ri.ingredient.carbsPer100g,
       fatPer100g: ri.ingredient.fatPer100g,
     }));
     const macros = calculateRecipeMacros(ingredientInputs, recipe.originalPortions ?? 1);
     ```
3. Display the computed macros in a section labeled "Macros par portion (calcul)" or similar:
   - Show: calories, protein, carbs, fat per serving
   - Show confidence indicator:
     - "high": green badge "Donnees fiables"
     - "medium": yellow badge "Valeurs approchees"
     - "low": orange badge "Estimation partielle" with tooltip "X/{total} ingredients convertis"
   - If the recipe already has `jowNutritionPerServing`, show BOTH the computed and original Jow values for comparison, clearly labeled
4. Keep the existing page layout and styling -- this is an addition, not a replacement
5. The confidence indicator should be subtle (small badge or icon next to the section title)

Import `calculateRecipeMacros` from `@/lib/nutrition`.

Note: Do NOT create a separate IngredientInput type export -- the recipe-macros.ts file already defines it internally. Just construct the objects inline matching the expected shape.
  </action>
  <verify>Run `pnpm build` -- page builds without errors. Run `pnpm dev` and visit a recipe detail page -- verify computed macros are shown with confidence indicator.</verify>
  <done>Recipe detail page shows computed per-serving macros with confidence indicator alongside Jow nutrition data. Missing ingredients are tracked and confidence level is displayed.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete macro calculation engine with UI:
    1. Dashboard at /dashboard showing daily calorie target and P/G/L macro targets
    2. Expandable detail view showing full calculation breakdown (BMR, TDEE, sport adjustment, goal modifier)
    3. Recipe detail pages now show computed macros per serving with data quality confidence indicator
    4. Header navigation includes link to macro dashboard
  </what-built>
  <how-to-verify>
    1. Log in and go to /dashboard
    2. Verify daily calorie target and P/G/L targets are displayed
    3. Click "Comment c'est calcule ?" to expand the detail view
    4. Verify the detail shows BMR, activity level adjustment, sport session calories, goal modifier
    5. Go to /settings/profile and change your goal (e.g., from maintien to seche)
    6. Return to /dashboard -- verify the targets have changed (seche should show lower calories, higher protein)
    7. Go to any recipe detail page (e.g., /recipes/[id])
    8. Verify computed macros per serving are shown with a confidence indicator
    9. Check that the confidence badge color makes sense (green for most complete recipes)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `pnpm build` -- full build succeeds
2. `pnpm test` -- all existing + new tests pass
3. `pnpm check` -- Biome passes
4. Dashboard renders at /dashboard with correct macro calculations
5. Recipe detail pages show computed macros with confidence
</verification>

<success_criteria>
- Dashboard page shows personalized daily calorie target and P/G/L macro targets
- Expandable detail view shows the full calculation chain transparently
- Recipe detail page shows computed per-serving macros with confidence scoring
- Changing profile goal updates macro targets without page refresh issues
- All 4 success criteria from ROADMAP Phase 5 are met
</success_criteria>

<output>
After completion, create `.planning/phases/05-macro-calculation-engine/05-04-SUMMARY.md`
</output>
