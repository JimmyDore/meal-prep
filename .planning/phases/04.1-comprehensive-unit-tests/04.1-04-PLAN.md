---
phase: 04.1-comprehensive-unit-tests
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/recipes/upload/__tests__/route.test.ts
  - src/db/__tests__/recipes.test.ts
  - src/db/__tests__/profiles.test.ts
autonomous: true

must_haves:
  truths:
    - "POST /api/recipes/upload returns 401 without bearer token and with wrong token"
    - "POST /api/recipes/upload returns 400 on invalid body (missing required fields, invalid macros)"
    - "POST /api/recipes/upload returns 200/201 on valid body with correct bearer token"
    - "getRecipes returns paginated results with correct totalCount"
    - "getRecipes search filter returns matching recipes"
    - "getRecipes tag filter returns recipes with all specified tags"
    - "getRecipeById returns recipe with ingredients and tags for valid UUID"
    - "getRecipeById returns null for non-existent UUID"
    - "upsertUserProfile creates and updates profile correctly"
    - "isProfileComplete returns false for incomplete profile"
  artifacts:
    - path: "src/app/api/recipes/upload/__tests__/route.test.ts"
      provides: "API upload route unit tests"
      min_lines: 60
    - path: "src/db/__tests__/recipes.test.ts"
      provides: "Recipe DB query integration tests"
      min_lines: 80
    - path: "src/db/__tests__/profiles.test.ts"
      provides: "Profile DB query integration tests"
      min_lines: 60
  key_links:
    - from: "src/app/api/recipes/upload/__tests__/route.test.ts"
      to: "@/db"
      via: "vi.mock('@/db')"
      pattern: "vi\\.mock.*@/db"
    - from: "src/app/api/recipes/upload/__tests__/route.test.ts"
      to: "@/lib/env"
      via: "vi.mock('@/lib/env')"
      pattern: "vi\\.mock.*@/lib/env"
    - from: "src/db/__tests__/recipes.test.ts"
      to: "src/test/db-setup.ts"
      via: "setupTestDb, cleanupTestDb"
      pattern: "setupTestDb|cleanupTestDb"
---

<objective>
Write unit tests for the API upload route (mocked DB and env) and integration tests for DB query functions (recipe queries and profile queries against the test database).

Purpose: Verify the upload API enforces auth and validation correctly, and DB queries return correct paginated, filtered, and joined results.
Output: 1 API route test file (unit, mocked) + 2 DB query test files (integration, real test DB).
</objective>

<execution_context>
@/Users/jimmydore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jimmydore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.1-comprehensive-unit-tests/04.1-RESEARCH.md

@src/app/api/recipes/upload/route.ts
@src/db/queries/recipes.ts
@src/db/queries/profiles.ts
@src/db/queries/tags.ts
@src/db/schema
@src/test/db-setup.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test API upload route with mocked DB and env</name>
  <files>src/app/api/recipes/upload/__tests__/route.test.ts</files>
  <action>
    Read `src/app/api/recipes/upload/route.ts` to understand the POST handler, auth logic, validation schema, and DB operations.

    Create test file with `vi.mock("@/db")` and `vi.mock("@/lib/env")` at top level BEFORE importing POST.

    **Auth tests:**
    - Returns 401 when no Authorization header
    - Returns 401 when Authorization header is not "Bearer {token}"
    - Returns 401 when token does not match PIPELINE_TOKEN

    **Validation tests:**
    - Returns 400 when body is empty {}
    - Returns 400 when body is missing required fields (e.g., title, jowId, ingredients)
    - Returns 400 when body has invalid macro values (e.g., proteinPer100g: 999)

    **Success test:**
    - Returns 200 or 201 when auth and validation pass
    - Mock `db.transaction` (or whatever DB method is used) to simulate successful upsert
    - Verify the response contains expected data

    **Error handling:**
    - Test DB error returns 500

    Use `new Request()` to construct test requests:
    ```ts
    const req = new Request("http://localhost/api/recipes/upload", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer test-token",
      },
      body: JSON.stringify({ /* valid recipe data */ }),
    });
    ```

    Mock env as: `{ env: { PIPELINE_TOKEN: "test-token" } }`
  </action>
  <verify>
    Run `pnpm test run src/app/api/recipes/upload/__tests__/route.test.ts` and verify all tests pass.
  </verify>
  <done>Upload route tested with 6+ cases covering auth (401), validation (400), success (201), and DB error (500).</done>
</task>

<task type="auto">
  <name>Task 2: Test DB query functions against test database</name>
  <files>src/db/__tests__/recipes.test.ts, src/db/__tests__/profiles.test.ts</files>
  <action>
    **PREREQUISITE:** The test DB container must be running. Start it if needed:
    ```bash
    docker compose up -d db-test
    ```

    Read `src/db/queries/recipes.ts`, `src/db/queries/profiles.ts`, and `src/test/db-setup.ts` to understand query signatures and test DB setup.

    **recipes.test.ts** — Integration tests against real test DB:
    - Use `setupTestDb()` in beforeAll, `cleanupTestDb()` in beforeEach, `closeTestDb()` in afterAll
    - Mock `@/db` to use `testDb` from `src/test/db-setup.ts`: `vi.mock("@/db", () => ({ db: testDb }))`
    - **Empty state:** getRecipes returns empty array and totalCount=0
    - **Insert test data:** Insert 3 recipes with known data directly via testDb, then:
      - getRecipes() returns 3 recipes with correct pagination
      - getRecipes({ page: 1, perPage: 2 }) returns 2 recipes with totalCount=3
      - getRecipes({ search: "poulet" }) returns matching recipes only
    - **Tags:** Insert recipes with tags, test getRecipes({ tags: ["rapide"] }) returns filtered results
    - **getRecipeById:** Returns recipe with ingredients and tags for valid UUID. Returns null for non-existent UUID.
    - **UUID validation:** getRecipeById with invalid UUID string returns null (not crash)

    **profiles.test.ts** — Integration tests against real test DB:
    - Same setup pattern with testDb mock
    - **upsertUserProfile:** Create profile, verify data. Update profile, verify changes persisted.
    - **getUserProfile:** Returns null for non-existent user. Returns profile for existing user.
    - **isProfileComplete:** Returns false when required fields are missing. Returns true when all 6 required fields (weight, height, age, sex, activityLevel, goal) are set.
    - **setUserDietaryPreferences:** Set preferences, verify. Update preferences (should replace, not append).
    - Insert test users directly via testDb for the user FK.

    **IMPORTANT:** These tests live in `src/db/__tests__/` and are excluded from CI via `--exclude 'src/db/**'`. They require the test DB container running on port 5434.
  </action>
  <verify>
    ```bash
    # Ensure test DB is running
    docker compose up -d db-test

    # Run DB integration tests only
    pnpm test run src/db/__tests__/recipes.test.ts src/db/__tests__/profiles.test.ts
    ```
  </verify>
  <done>Recipe queries tested with 8+ cases (empty, paginated, search, tag filter, getById, invalid UUID). Profile queries tested with 6+ cases (upsert, get, isComplete, dietary preferences).</done>
</task>

</tasks>

<verification>
```bash
# API route tests (unit, no DB needed)
pnpm test run src/app/api/recipes/upload/__tests__/route.test.ts

# DB integration tests (need test DB running)
docker compose up -d db-test
pnpm test run src/db/__tests__/recipes.test.ts src/db/__tests__/profiles.test.ts
```
</verification>

<success_criteria>
- 3 test files exist (route, recipes, profiles)
- API route tests pass without Docker (mocked DB)
- DB integration tests pass with test DB running
- 20+ total test assertions across all 3 files
- Auth, validation, pagination, search, filter, and profile CRUD all tested
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-comprehensive-unit-tests/04.1-04-SUMMARY.md`
</output>
