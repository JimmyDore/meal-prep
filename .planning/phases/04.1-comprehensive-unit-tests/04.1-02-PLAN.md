---
phase: 04.1-comprehensive-unit-tests
plan: 02
type: execute
wave: 2
depends_on: ["04.1-01"]
files_modified:
  - scripts/pipeline/lib/__tests__/jsonl.test.ts
  - scripts/pipeline/lib/__tests__/api-client.test.ts
  - scripts/pipeline/lib/__tests__/claude-enricher-impure.test.ts
  - scripts/pipeline/lib/__tests__/ingredient-extractor.test.ts
autonomous: true

must_haves:
  truths:
    - "JSONL utilities (readJsonl, writeJsonl, appendJsonl, countLines) are tested with mocked filesystem operations"
    - "API client (uploadRecipe) is tested with mocked fetch for success, validation error, auth error, and network failure cases"
    - "Claude enricher impure functions (enrichRecipe, enrichRecipeWithRetry) are tested with mocked execSync and filesystem"
    - "Ingredient extractor (extractUniqueIngredients) is tested with mocked readJsonl returning known recipe data"
  artifacts:
    - path: "scripts/pipeline/lib/__tests__/jsonl.test.ts"
      provides: "JSONL filesystem utility tests with mocked fs"
      min_lines: 60
    - path: "scripts/pipeline/lib/__tests__/api-client.test.ts"
      provides: "API client tests with mocked fetch"
      min_lines: 50
    - path: "scripts/pipeline/lib/__tests__/claude-enricher-impure.test.ts"
      provides: "Claude enricher impure function tests with mocked child_process/fs"
      min_lines: 60
    - path: "scripts/pipeline/lib/__tests__/ingredient-extractor.test.ts"
      provides: "Ingredient extractor tests with mocked readJsonl"
      min_lines: 40
  key_links:
    - from: "scripts/pipeline/lib/__tests__/api-client.test.ts"
      to: "globalThis.fetch"
      via: "vi.fn() mock"
      pattern: "globalThis\\.fetch.*vi\\.fn"
    - from: "scripts/pipeline/lib/__tests__/claude-enricher-impure.test.ts"
      to: "node:child_process"
      via: "vi.mock()"
      pattern: 'vi\.mock\("node:child_process"'
---

<objective>
Write unit tests for all pipeline impure functions by mocking external dependencies (filesystem, fetch, child_process).

Purpose: Verify pipeline I/O functions handle success and error cases correctly without actually hitting the filesystem, network, or spawning processes.
Output: 4 test files covering JSONL utilities, API client, Claude enricher orchestration, and ingredient extraction.
</objective>

<execution_context>
@/Users/jimmydore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jimmydore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.1-comprehensive-unit-tests/04.1-RESEARCH.md

@scripts/pipeline/lib/jsonl.ts
@scripts/pipeline/lib/api-client.ts
@scripts/pipeline/lib/claude-enricher.ts
@scripts/pipeline/lib/ingredient-extractor.ts
@scripts/pipeline/lib/types.ts
@scripts/pipeline/lib/schemas.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test JSONL utilities and API client with mocks</name>
  <files>scripts/pipeline/lib/__tests__/jsonl.test.ts, scripts/pipeline/lib/__tests__/api-client.test.ts</files>
  <action>
    **jsonl.test.ts** — Mock `node:fs` and `node:readline` to test JSONL utilities:
    - Read the actual jsonl.ts implementation first to understand the exact functions (readJsonl, writeJsonl, appendJsonl, countLines) and their signatures.
    - For `readJsonl`: mock createReadStream to return a readable stream with known JSONL lines. Verify it parses each line as JSON and returns the array. Test with empty file, single line, multiple lines, and malformed JSON line (should skip or throw based on implementation).
    - For `writeJsonl`: mock writeFile. Verify it converts objects to JSONL format (one JSON per line). Test with empty array, single object, multiple objects.
    - For `appendJsonl`: mock appendFile. Verify it appends a single JSON line with newline.
    - For `countLines`: mock approach depends on implementation. Test returns correct count.
    - Use `vi.mock("node:fs", ...)` and `vi.mock("node:readline", ...)` at module scope before imports.

    **Alternative for JSONL if stream mocking is complex:** Use `vi.mock("node:fs")` with a simpler approach — if readJsonl uses `readFileSync` or a simpler API, mock that. Read the actual implementation to determine the best mock strategy.

    **api-client.test.ts** — Mock `globalThis.fetch` to test API client:
    - Read api-client.ts to understand the `createApiClient` function signature and uploadRecipe method.
    - Test success (201 response with { id: "uuid" }) -> returns success result
    - Test validation error (400 response with { error: "..." }) -> returns error
    - Test auth error (401 response) -> returns auth error
    - Test network failure (fetch throws) -> handles gracefully
    - Mock fetch as `globalThis.fetch = vi.fn()` in beforeEach, restore in afterEach.
    - Create minimal enriched recipe fixtures inline for the request body.

    **IMPORTANT:** Use relative imports only (not @/* aliases).
  </action>
  <verify>
    Run `pnpm test run scripts/pipeline/lib/__tests__/jsonl.test.ts scripts/pipeline/lib/__tests__/api-client.test.ts` and verify all tests pass.
  </verify>
  <done>JSONL utilities tested with 6+ cases covering read/write/append/count with mocked fs. API client tested with 4+ cases covering success, validation error, auth error, network failure.</done>
</task>

<task type="auto">
  <name>Task 2: Test Claude enricher impure functions and ingredient extractor with mocks</name>
  <files>scripts/pipeline/lib/__tests__/claude-enricher-impure.test.ts, scripts/pipeline/lib/__tests__/ingredient-extractor.test.ts</files>
  <action>
    **claude-enricher-impure.test.ts** — Mock `node:child_process`, `node:fs`, `node:os`, `node:crypto` to test enricher orchestration:
    - Read claude-enricher.ts to understand enrichRecipe and enrichRecipeWithRetry signatures.
    - Mock `execSync` to return a valid Claude CLI JSON response (with structured_output.ingredients array).
    - Mock `readFileSync` for the prompt file read.
    - Mock `writeFileSync` and `unlinkSync` for temp file operations.
    - Mock `tmpdir` -> "/tmp" and `randomUUID` -> "mock-uuid".
    - Test `enrichRecipe` success: execSync returns valid response -> function returns parsed ingredients.
    - Test `enrichRecipe` failure: execSync throws -> function propagates error or returns empty.
    - Test `enrichRecipeWithRetry` (if exported): retries on failure, returns success on second attempt.
    - Test with aberrant values that trigger Zod validation failure -> retry or rejection based on implementation.

    **ingredient-extractor.test.ts** — Mock the JSONL reading to test ingredient extraction:
    - Read ingredient-extractor.ts to understand `extractUniqueIngredients` signature and what it imports.
    - Mock the readJsonl dependency (either via `vi.mock("../jsonl")` or by mocking the filesystem).
    - Test with known recipe data: 3 recipes with overlapping ingredients -> verify deduplication count.
    - Test with empty recipe list -> returns empty set/array.
    - Test with recipes that have no ingredients -> handles gracefully.
    - Verify the output format matches expectations (set of unique ingredient names, or whatever the function returns).

    **IMPORTANT:** All `vi.mock()` calls must be at module top level, BEFORE any imports from the mocked modules. Use relative imports only.
  </action>
  <verify>
    Run `pnpm test run scripts/pipeline/lib/__tests__/claude-enricher-impure.test.ts scripts/pipeline/lib/__tests__/ingredient-extractor.test.ts` and verify all tests pass.
  </verify>
  <done>Claude enricher impure functions tested with 4+ cases covering success, failure, retry, and validation rejection. Ingredient extractor tested with 3+ cases covering deduplication, empty input, and edge cases.</done>
</task>

</tasks>

<verification>
```bash
# All pipeline impure function tests pass
pnpm test run scripts/pipeline/lib/__tests__/

# No real filesystem, network, or process calls happen during tests
# (verified by mock setup in each file)
```
</verification>

<success_criteria>
- 4 test files exist in scripts/pipeline/lib/__tests__/
- All tests pass with `pnpm test run scripts/pipeline/lib/__tests__/`
- No real external calls (fs, fetch, execSync) happen during tests
- 15+ total test assertions covering success and error paths
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-comprehensive-unit-tests/04.1-02-SUMMARY.md`
</output>
