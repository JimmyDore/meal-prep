---
phase: 04.1-comprehensive-unit-tests
plan: 02
subsystem: testing
tags: [vitest, mocking, pipeline, jsonl, api-client, claude-enricher, ingredient-extractor]

# Dependency graph
requires:
  - phase: 04.1-01
    provides: "Pipeline pure function tests, vitest config for scripts/**/*.test.ts, exported pure helpers"
  - phase: 02
    provides: "Pipeline library modules (jsonl, api-client, claude-enricher, ingredient-extractor)"
provides:
  - "39 unit tests for pipeline impure functions with fully mocked I/O"
  - "JSONL fs utility tests (read/write/append/count)"
  - "API client tests with mocked fetch (success/error/auth/network)"
  - "Claude enricher impure tests with mocked execSync/fs/os/crypto"
  - "Ingredient extractor tests with mocked readJsonl"
affects: [04.1-comprehensive-unit-tests]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "vi.mock(import(...)) with importOriginal + default export for Node.js built-in modules"
    - "Mutable module-level array for controlling async generator mock output"
    - "globalThis.fetch save/restore pattern for fetch mocking"

key-files:
  created:
    - scripts/pipeline/lib/__tests__/jsonl.test.ts
    - scripts/pipeline/lib/__tests__/api-client.test.ts
    - scripts/pipeline/lib/__tests__/claude-enricher-impure.test.ts
    - scripts/pipeline/lib/__tests__/ingredient-extractor.test.ts
  modified: []

key-decisions:
  - "vi.mock(import(...)) with default export spread required for Node.js built-in modules in vitest 4.x"
  - "Mutable array + async generator pattern for mocking readJsonl without complex stream mocking"
  - "Readable.from(string) for mocking createReadStream -- avoids complex stream pipe setup"

patterns-established:
  - "Node.js built-in mock pattern: importOriginal + spread actual + override default + override named exports"
  - "Async generator mock: module-level mutable array yielded in mock factory"

# Metrics
duration: 3min
completed: 2026-02-08
---

# Phase 4.1 Plan 02: Pipeline Impure Function Tests Summary

**39 unit tests for pipeline I/O functions (JSONL, API client, Claude CLI enricher, ingredient extractor) with fully mocked filesystem, fetch, and child_process**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-08T22:01:32Z
- **Completed:** 2026-02-08T22:05:01Z
- **Tasks:** 2
- **Files created:** 4

## Accomplishments
- 13 tests for JSONL utilities covering readJsonl (stream parsing, empty, skip blanks, malformed), writeJsonl (multi/empty/single), appendJsonl (single/nested), countLines (count/empty/blanks)
- 7 tests for API client covering uploadRecipe success (201), validation error (400), auth failure (401), server error (500), network failure, payload structure verification, non-Error throw handling
- 13 tests for Claude enricher impure functions covering enrichRecipe (success, temp file cleanup, CLI failure, missing ingredients, Zod rejection), enrichRecipeWithRetry (pass/retry-pass/retry-fail/retry-throw), enrichIngredientBatch (success, count mismatch), enrichIngredientBatchWithRetry (pass, double-fail flagged)
- 6 tests for ingredient extractor covering deduplication across recipes, empty file, no ingredients, sorted output, single ingredient, case preservation

## Task Commits

Each task was committed atomically:

1. **Task 1: Test JSONL utilities and API client with mocks** - `660f7b1` (test)
2. **Task 2: Test Claude enricher impure functions and ingredient extractor with mocks** - `922fb2e` (test)

## Files Created/Modified
- `scripts/pipeline/lib/__tests__/jsonl.test.ts` - 13 tests for JSONL filesystem utilities with mocked node:fs and node:fs/promises
- `scripts/pipeline/lib/__tests__/api-client.test.ts` - 7 tests for API client with mocked globalThis.fetch
- `scripts/pipeline/lib/__tests__/claude-enricher-impure.test.ts` - 13 tests for enrichRecipe/enrichRecipeWithRetry/enrichIngredientBatch/enrichIngredientBatchWithRetry with mocked child_process/fs/os/crypto
- `scripts/pipeline/lib/__tests__/ingredient-extractor.test.ts` - 6 tests for extractUniqueIngredients with mocked readJsonl async generator

## Decisions Made
- Used `vi.mock(import("node:fs"), async (importOriginal) => { ... })` pattern with explicit `default` export spread because vitest 4.x requires default export presence for Node.js built-in CJS modules. Simple `vi.mock("node:fs", () => ({...}))` fails with "No default export" error.
- Used `Readable.from(string)` to mock `createReadStream` return value -- avoids complex stream piping setup while working with real `createInterface` from `node:readline`.
- Used module-level mutable array with async generator factory for mocking `readJsonl` in ingredient extractor tests -- simpler than mocking filesystem for an async generator function.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Fixed vitest 4.x Node.js built-in module mock pattern**
- **Found during:** Task 1 (JSONL tests)
- **Issue:** `vi.mock("node:fs", () => ({...}))` fails with "No default export is defined" because vitest 4.x validates CJS module structure
- **Fix:** Used `vi.mock(import("node:fs"), async (importOriginal) => { const actual = await importOriginal(); return { ...actual, default: {...actual, ...overrides}, ...overrides }; })` pattern
- **Files modified:** jsonl.test.ts, claude-enricher-impure.test.ts
- **Verification:** All tests pass
- **Committed in:** 660f7b1, 922fb2e

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** Required pattern discovery for vitest 4.x Node.js built-in mocking. No scope creep.

## Issues Encountered
- Vitest 4.x requires explicit `default` export on mocked Node.js built-in modules. Resolved by using `importOriginal` pattern with spread of actual module plus `default` key.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- All pipeline library functions now have comprehensive test coverage (pure + impure)
- 135 total tests across 8 test files in scripts/pipeline/lib/__tests__/
- Ready for remaining Phase 4.1 plans or Phase 5+

---
*Phase: 04.1-comprehensive-unit-tests*
*Completed: 2026-02-08*
