---
phase: 04.1-comprehensive-unit-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vitest.config.mts
  - scripts/pipeline/lib/claude-enricher.ts
  - scripts/pipeline/lib/__tests__/jow-parser.test.ts
  - scripts/pipeline/lib/__tests__/recipe-assembler.test.ts
  - scripts/pipeline/lib/__tests__/claude-enricher-pure.test.ts
autonomous: true

must_haves:
  truths:
    - "Pipeline pure functions (extractJowId, extractRecipeSlug, parseIsoDuration, parseNextDataRecipe, parseJsonLdRecipe) are tested with boundary values and edge cases"
    - "Recipe assembler (assembleEnrichedRecipe) is tested with valid data, missing ingredients, empty macros lookup"
    - "Claude enricher pure helpers (parseClaudeOutput, validateIngredients, boundsCheck, crossValidateNutrition) are tested with valid, boundary, and invalid data"
    - "Vitest config includes scripts/**/*.test.ts pattern for pipeline test discovery"
  artifacts:
    - path: "scripts/pipeline/lib/__tests__/jow-parser.test.ts"
      provides: "Parser pure function tests"
      min_lines: 80
    - path: "scripts/pipeline/lib/__tests__/recipe-assembler.test.ts"
      provides: "Recipe assembler pure function tests"
      min_lines: 40
    - path: "scripts/pipeline/lib/__tests__/claude-enricher-pure.test.ts"
      provides: "Claude enricher pure helper tests"
      min_lines: 60
  key_links:
    - from: "vitest.config.mts"
      to: "scripts/**/*.test.ts"
      via: "include array pattern"
      pattern: "scripts/\\*\\*/\\*.test.ts"
    - from: "scripts/pipeline/lib/claude-enricher.ts"
      to: "scripts/pipeline/lib/__tests__/claude-enricher-pure.test.ts"
      via: "exported pure helpers"
      pattern: "export.*(parseClaudeOutput|validateIngredients|boundsCheck)"
---

<objective>
Fix vitest config to discover pipeline tests, export private pure helpers from claude-enricher.ts, and write comprehensive unit tests for all pipeline pure functions.

Purpose: Establish test coverage for the core parsing and validation logic that the entire data pipeline relies on, ensuring correctness of recipe data flowing through the system.
Output: 3 test files covering jow-parser, recipe-assembler, and claude-enricher pure helpers. Vitest config updated.
</objective>

<execution_context>
@/Users/jimmydore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jimmydore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.1-comprehensive-unit-tests/04.1-RESEARCH.md

@vitest.config.mts
@scripts/pipeline/lib/jow-parser.ts
@scripts/pipeline/lib/recipe-assembler.ts
@scripts/pipeline/lib/claude-enricher.ts
@scripts/pipeline/lib/types.ts
@scripts/pipeline/lib/schemas.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix vitest config and export private pure helpers</name>
  <files>vitest.config.mts, scripts/pipeline/lib/claude-enricher.ts</files>
  <action>
    1. In `vitest.config.mts`, add `"scripts/**/*.test.ts"` to the `include` array so pipeline tests are discovered:
       ```ts
       include: ["src/**/*.test.{ts,tsx}", "scripts/**/*.test.ts"],
       ```

    2. In `scripts/pipeline/lib/claude-enricher.ts`, export the following currently-private pure functions so they can be tested directly:
       - `parseClaudeOutput` — parses the Claude CLI JSON response
       - `validateIngredients` — validates ingredient array against Zod schema
       - `boundsCheck` — checks if macro values are within reasonable bounds

       These are pure functions with clear inputs/outputs. Do NOT export impure functions (enrichRecipe, enrichRecipeWithRetry, etc. stay private to their callers).

       Find each function declaration and add `export` keyword. If they use `function` syntax, change to `export function`. Keep the existing function signatures unchanged.

    3. Verify `crossValidateNutrition` is already exported (it should be per prior decisions).
  </action>
  <verify>
    - `pnpm exec vitest --list 2>&1 | grep scripts` shows pipeline test patterns are recognized (once test files exist)
    - `grep -n "export.*parseClaudeOutput\|export.*validateIngredients\|export.*boundsCheck" scripts/pipeline/lib/claude-enricher.ts` shows all 3 functions are exported
  </verify>
  <done>Vitest discovers scripts/**/*.test.ts files. parseClaudeOutput, validateIngredients, boundsCheck are exported from claude-enricher.ts for direct testing.</done>
</task>

<task type="auto">
  <name>Task 2: Test pipeline pure functions (jow-parser, recipe-assembler, claude-enricher helpers)</name>
  <files>scripts/pipeline/lib/__tests__/jow-parser.test.ts, scripts/pipeline/lib/__tests__/recipe-assembler.test.ts, scripts/pipeline/lib/__tests__/claude-enricher-pure.test.ts</files>
  <action>
    Create `scripts/pipeline/lib/__tests__/` directory and write 3 test files. Use RELATIVE imports only (not @/* aliases — those resolve to src/*).

    **jow-parser.test.ts** — Test all exported functions:
    - `extractJowId`: full URL, relative path, no-dash segment, empty string
    - `extractRecipeSlug`: full URL extracts slug without ID, handles edge cases
    - `parseIsoDuration`: PT30M=30, PT1H15M=75, PT1H=60, PT2H30M=150, empty=""->null, invalid format->null, case insensitive (pt30m)
    - `parseNextDataRecipe`: pass a minimal __NEXT_DATA__ structure, verify it extracts title, ingredients, portions, timing, photo. Test with missing fields returning null/defaults.
    - `parseJsonLdRecipe`: pass a minimal JSON-LD recipe structure, verify extraction. Test with missing fields.
    Use `it.each()` for parameterized cases where appropriate (especially parseIsoDuration).

    **recipe-assembler.test.ts** — Test `assembleEnrichedRecipe`:
    - Valid case: scraped recipe + macros lookup with matching ingredients -> returns enriched recipe with correct macros
    - Missing ingredient: some ingredients not in lookup -> enriched recipe has ingredients without macros (or partial), check _flags
    - Empty macros lookup: all ingredients missing -> verify function doesn't crash, returns recipe with appropriate flags
    - Create minimal test fixtures inline (not external files)

    **claude-enricher-pure.test.ts** — Test exported pure helpers:
    - `parseClaudeOutput`: valid JSON with structured_output.ingredients -> returns ingredients array. Invalid JSON -> throws or returns error. Missing structured_output key -> handles gracefully.
    - `validateIngredients`: valid ingredient array passes. Invalid values (protein>100, negative calories) rejected by Zod.
    - `boundsCheck`: values at boundaries (0, 100 for macros, 0, 900 for calories) pass. Values outside (101, -1, 901) fail.
    - `crossValidateNutrition`: test with matching Jow nutrition data vs enriched data, test with significant deviation triggering warning.

    **IMPORTANT:** All pipeline test files must use relative imports:
    ```ts
    import { extractJowId } from "../jow-parser";
    ```
    NOT:
    ```ts
    import { extractJowId } from "@/...";
    ```
  </action>
  <verify>
    Run `pnpm test run scripts/pipeline/lib/__tests__/` and verify all tests pass. Count should be 20+ assertions across the 3 files.
  </verify>
  <done>jow-parser has 10+ test cases covering all exported functions with edge cases. recipe-assembler has 3+ test cases for valid, partial, and empty scenarios. claude-enricher pure helpers have 10+ test cases covering parsing, validation, bounds checking, and cross-validation.</done>
</task>

</tasks>

<verification>
```bash
# All pipeline pure function tests pass
pnpm test run scripts/pipeline/lib/__tests__/

# Vitest config includes scripts pattern
grep 'scripts' vitest.config.mts

# Private functions are now exported
grep -c 'export.*function.*\(parseClaudeOutput\|validateIngredients\|boundsCheck\)' scripts/pipeline/lib/claude-enricher.ts
```
</verification>

<success_criteria>
- 3 test files exist in scripts/pipeline/lib/__tests__/
- All tests pass with `pnpm test run scripts/pipeline/lib/__tests__/`
- vitest.config.mts includes "scripts/**/*.test.ts" in include array
- parseClaudeOutput, validateIngredients, boundsCheck are exported from claude-enricher.ts
- 20+ total test assertions covering boundary values and edge cases
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-comprehensive-unit-tests/04.1-01-SUMMARY.md`
</output>
