---
phase: 04.1-comprehensive-unit-tests
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/pipeline/lib/__tests__/schemas.test.ts
  - src/lib/schemas/__tests__/profile.test.ts
autonomous: true

must_haves:
  truths:
    - "Pipeline Zod schemas (scrapedRecipeSchema, enrichedIngredientSchema, ingredientMacroSchema, enrichedRecipeSchema) reject values outside bounds (protein/carbs/fat >100, calories >900, negative values)"
    - "Pipeline Zod schemas accept valid values at exact boundaries (0, 100 for macros, 0, 900 for calories)"
    - "Profile Zod schemas (physicalSchema, goalSchema, dietarySchema, sportSchema, profileSchema) reject invalid enum values, out-of-range numbers, and missing required fields"
    - "Profile Zod schemas accept valid data at boundaries (weight 30 and 300, height 100 and 250, age 10 and 120)"
  artifacts:
    - path: "scripts/pipeline/lib/__tests__/schemas.test.ts"
      provides: "Pipeline Zod schema boundary tests"
      min_lines: 80
    - path: "src/lib/schemas/__tests__/profile.test.ts"
      provides: "Profile Zod schema boundary tests"
      min_lines: 80
  key_links:
    - from: "scripts/pipeline/lib/__tests__/schemas.test.ts"
      to: "scripts/pipeline/lib/schemas.ts"
      via: "import schemas"
      pattern: "import.*from.*schemas"
    - from: "src/lib/schemas/__tests__/profile.test.ts"
      to: "src/lib/schemas/profile.ts"
      via: "import schemas"
      pattern: "import.*from.*profile"
---

<objective>
Write comprehensive boundary tests for all Zod validation schemas: pipeline schemas (macro bounds, required fields) and user profile schemas (physical metrics, goals, dietary preferences, sport activities).

Purpose: Ensure data contracts are enforced at the boundaries where external data enters the system -- scraped recipes, enriched nutrition data, and user profile input.
Output: 2 test files with thorough boundary testing for all Zod schemas.
</objective>

<execution_context>
@/Users/jimmydore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jimmydore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.1-comprehensive-unit-tests/04.1-RESEARCH.md

@scripts/pipeline/lib/schemas.ts
@scripts/pipeline/lib/types.ts
@src/lib/schemas/profile.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test pipeline Zod schemas at boundaries</name>
  <files>scripts/pipeline/lib/__tests__/schemas.test.ts</files>
  <action>
    Read `scripts/pipeline/lib/schemas.ts` to identify all exported schemas and their exact constraints (min/max values, required fields, enums).

    Create `scripts/pipeline/lib/__tests__/schemas.test.ts` with boundary tests. Use RELATIVE imports only.

    **enrichedIngredientSchema** (or ingredientMacroSchema â€” check exact name):
    - Accept: proteinPer100g=0, carbsPer100g=0, fatPer100g=0, caloriesPer100g=0, confidence="high" (all at lower bound)
    - Accept: proteinPer100g=100, carbsPer100g=100, fatPer100g=100, caloriesPer100g=900 (all at upper bound)
    - Reject: proteinPer100g=101 (over max)
    - Reject: proteinPer100g=-1 (negative)
    - Reject: caloriesPer100g=901 (over max)
    - Reject: caloriesPer100g=-1 (negative)
    - Reject: missing required field (name)
    - Reject: invalid confidence value
    - Accept: confidence="low", confidence="medium", confidence="high" (all valid enum values)

    **scrapedRecipeSchema**:
    - Accept: minimal valid scraped recipe (all required fields)
    - Reject: missing title (or whatever is required)
    - Reject: empty ingredients array if that's invalid
    - Test optional fields are truly optional

    **enrichedRecipeSchema**:
    - Accept: valid enriched recipe with all ingredients having valid macros
    - Reject: ingredients with macros outside bounds
    - Test with empty ingredients array

    Use `safeParse` for all tests to check `result.success` and access `result.error.issues` when needed.
  </action>
  <verify>
    Run `pnpm test run scripts/pipeline/lib/__tests__/schemas.test.ts` and verify all tests pass. Should have 15+ assertions.
  </verify>
  <done>Pipeline schemas have 15+ boundary test cases covering min/max values, invalid types, missing required fields, and valid enum values.</done>
</task>

<task type="auto">
  <name>Task 2: Test profile Zod schemas at boundaries</name>
  <files>src/lib/schemas/__tests__/profile.test.ts</files>
  <action>
    Read `src/lib/schemas/profile.ts` to identify all exported schemas and their exact constraints.

    Create `src/lib/schemas/__tests__/profile.test.ts`. This file is in `src/` so it CAN use `@/*` imports but direct relative import is also fine.

    **physicalSchema**:
    - Accept: weight=30, height=100, age=10 (lower bounds)
    - Accept: weight=300, height=250, age=120 (upper bounds)
    - Accept: sex="homme", sex="femme" (valid enum values)
    - Accept: all valid activityLevel values
    - Reject: weight=29 (below min), weight=301 (above max)
    - Reject: height=99, height=251
    - Reject: age=9, age=121
    - Reject: sex="invalid" (not in enum)
    - Reject: activityLevel="invalid"
    - Reject: missing required field (any)

    **goalSchema**:
    - Accept: each valid goal value ("seche", "prise_de_masse", "maintien" or whatever the enum values are)
    - Reject: invalid goal value

    **dietarySchema**:
    - Accept: valid array of preferences
    - Accept: empty array (no preferences is valid)
    - Reject: invalid preference value in array

    **sportSchema**:
    - Accept: valid sport activity array
    - Accept: empty array
    - Test each valid activity type and frequency range

    **profileSchema** (composite):
    - Accept: full valid profile with all sub-schemas satisfied
    - Reject: profile with invalid sub-schema data

    Use `safeParse` for all tests.
  </action>
  <verify>
    Run `pnpm test run src/lib/schemas/__tests__/profile.test.ts` and verify all tests pass. Should have 15+ assertions.
  </verify>
  <done>Profile schemas have 15+ boundary test cases covering weight/height/age bounds, enum validation, optional arrays, and composite profile validation.</done>
</task>

</tasks>

<verification>
```bash
# Pipeline schema tests pass
pnpm test run scripts/pipeline/lib/__tests__/schemas.test.ts

# Profile schema tests pass
pnpm test run src/lib/schemas/__tests__/profile.test.ts

# Combined count
pnpm test run scripts/pipeline/lib/__tests__/schemas.test.ts src/lib/schemas/__tests__/profile.test.ts
```
</verification>

<success_criteria>
- 2 test files exist (pipeline schemas + profile schemas)
- All tests pass
- 30+ total boundary test assertions across both files
- Both min and max boundaries tested for every numeric constraint
- All enum values tested (valid + invalid)
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-comprehensive-unit-tests/04.1-03-SUMMARY.md`
</output>
