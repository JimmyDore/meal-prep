---
phase: 04.1-comprehensive-unit-tests
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/auth/__tests__/login-form.test.tsx
  - src/components/auth/__tests__/register-form.test.tsx
  - src/components/onboarding/__tests__/wizard.test.tsx
autonomous: true

must_haves:
  truths:
    - "LoginForm renders email and password fields, shows validation errors for empty fields, and calls authClient.signIn.email on submit"
    - "RegisterForm renders all fields including password confirmation, validates password match, and calls authClient.signUp.email then signIn on submit"
    - "OnboardingWizard renders 4 steps, navigates forward/backward, validates per step, and calls saveProfile server action on final submit"
  artifacts:
    - path: "src/components/auth/__tests__/login-form.test.tsx"
      provides: "LoginForm component tests"
      min_lines: 50
    - path: "src/components/auth/__tests__/register-form.test.tsx"
      provides: "RegisterForm component tests"
      min_lines: 50
    - path: "src/components/onboarding/__tests__/wizard.test.tsx"
      provides: "OnboardingWizard component tests"
      min_lines: 80
  key_links:
    - from: "src/components/auth/__tests__/login-form.test.tsx"
      to: "@/lib/auth-client"
      via: "vi.mock('@/lib/auth-client')"
      pattern: "vi\\.mock.*auth-client"
    - from: "src/components/onboarding/__tests__/wizard.test.tsx"
      to: "saveProfile server action"
      via: "vi.mock()"
      pattern: "vi\\.mock.*actions/profile"
---

<objective>
Write unit tests for the authentication forms (LoginForm, RegisterForm) and the onboarding wizard, mocking authClient and server actions.

Purpose: Verify that auth flows and the multi-step onboarding wizard handle user interactions, validation, and API calls correctly.
Output: 3 test files covering login, registration, and onboarding wizard components.
</objective>

<execution_context>
@/Users/jimmydore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jimmydore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.1-comprehensive-unit-tests/04.1-RESEARCH.md

@src/components/auth/login-form.tsx
@src/components/auth/register-form.tsx
@src/components/onboarding/wizard.tsx
@src/components/onboarding/step-physical.tsx
@src/components/onboarding/step-goal.tsx
@src/components/onboarding/step-dietary.tsx
@src/components/onboarding/step-sport.tsx
@src/lib/auth-client.ts
@src/lib/schemas/profile.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test LoginForm and RegisterForm with mocked authClient</name>
  <files>src/components/auth/__tests__/login-form.test.tsx, src/components/auth/__tests__/register-form.test.tsx</files>
  <action>
    Read `src/components/auth/login-form.tsx` and `src/components/auth/register-form.tsx` to understand exact form structure, validation, and authClient usage.

    **Mocks needed (top of each file):**
    ```tsx
    const mockPush = vi.fn();
    const mockSignInEmail = vi.fn();

    vi.mock("next/navigation", () => ({
      useRouter: () => ({ push: mockPush }),
    }));

    vi.mock("@/lib/auth-client", () => ({
      authClient: {
        signIn: { email: mockSignInEmail },
        signUp: { email: vi.fn() },
      },
    }));
    ```

    **login-form.test.tsx:**
    - Renders email input and password input
    - Renders submit button with correct text
    - Shows validation error when submitting empty form (if client-side validation exists)
    - Calls authClient.signIn.email with { email, password } on valid submit
    - On successful signIn (mock returns success), navigates with router.push
    - On failed signIn (mock returns error), displays error message
    - Disables submit button during loading state

    **register-form.test.tsx:**
    - Renders email, password, and confirm password fields (and name if exists)
    - Shows error when passwords don't match
    - Calls authClient.signUp.email on valid submit with matching passwords
    - On successful signUp, calls signIn automatically then navigates
    - On failed signUp, displays error message
    - Disables submit button during loading state

    **IMPORTANT:** Mock authClient with realistic return values:
    - Success: `{ data: { user: {...} }, error: null }`
    - Error: `{ data: null, error: { message: "Invalid credentials" } }`
    Read the actual component code to see how it handles the response.

    Use `fireEvent.change` for inputs and `fireEvent.submit` or `fireEvent.click` for form submission. Wrap async operations in `await act(async () => { ... })`.
  </action>
  <verify>
    Run `pnpm test run src/components/auth/__tests__/` and verify all tests pass.
  </verify>
  <done>LoginForm tested with 5+ cases (rendering, validation, success flow, error flow, loading state). RegisterForm tested with 5+ cases (rendering, password match, success flow, error flow, loading state).</done>
</task>

<task type="auto">
  <name>Task 2: Test OnboardingWizard with mocked server action</name>
  <files>src/components/onboarding/__tests__/wizard.test.tsx</files>
  <action>
    Read `src/components/onboarding/wizard.tsx` and the step components to understand:
    - How the wizard manages step state (which step is current)
    - How react-hook-form is set up (FormProvider wrapping steps)
    - How validation works per step (which fields are validated before advancing)
    - How the server action is called on final submit
    - What props the wizard receives

    **Mocks needed:**
    ```tsx
    const mockPush = vi.fn();
    const mockSaveProfile = vi.fn();

    vi.mock("next/navigation", () => ({
      useRouter: () => ({ push: mockPush }),
    }));

    // Mock the server action module - read the import path from wizard.tsx
    vi.mock("@/app/actions/profile", () => ({
      saveProfile: mockSaveProfile,
    }));

    // Mock sonner if used
    vi.mock("sonner", () => ({
      toast: { success: vi.fn(), error: vi.fn() },
    }));
    ```

    **Tests:**
    - Renders step 1 (Physical) content on initial render
    - Shows progress indicator at step 1 of 4
    - "Precedent" button is hidden or disabled on step 1
    - After filling step 1 fields and clicking "Suivant", advances to step 2
    - Step validation: clicking "Suivant" without filling required fields stays on current step (shows validation errors)
    - "Precedent" button on step 2+ goes back to previous step with data preserved
    - On final step, submit button calls saveProfile server action with complete form data
    - On successful saveProfile (mock returns success), navigates to /recipes or dashboard
    - On failed saveProfile (mock throws), shows error toast

    **IMPORTANT for react-hook-form testing:**
    - The wizard uses FormProvider which provides form context to all steps
    - Fill inputs with `fireEvent.change` targeting the actual input elements
    - Wrap all interactions in `act()` since form state updates are async
    - Use `screen.getByRole` or `screen.getByLabelText` to find form fields

    **Keep scope manageable:** Focus on step navigation and final submit. Don't exhaustively test every field in every step (that's what the Zod schema tests cover).
  </action>
  <verify>
    Run `pnpm test run src/components/onboarding/__tests__/wizard.test.tsx` and verify all tests pass.
  </verify>
  <done>OnboardingWizard tested with 7+ cases covering step rendering, navigation forward/backward, validation blocking, final submission, success redirect, and error handling.</done>
</task>

</tasks>

<verification>
```bash
# Auth component tests pass
pnpm test run src/components/auth/__tests__/

# Onboarding wizard tests pass
pnpm test run src/components/onboarding/__tests__/

# All together
pnpm test run src/components/auth/__tests__/ src/components/onboarding/__tests__/
```
</verification>

<success_criteria>
- 3 test files exist (login-form, register-form, wizard)
- All tests pass
- 15+ total assertions across all 3 files
- authClient properly mocked (no real API calls)
- Server action properly mocked (no real DB calls)
- Form validation, success flows, and error flows all tested
- Wizard step navigation tested forward and backward
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-comprehensive-unit-tests/04.1-06-SUMMARY.md`
</output>
