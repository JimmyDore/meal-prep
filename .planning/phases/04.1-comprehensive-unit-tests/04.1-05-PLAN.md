---
phase: 04.1-comprehensive-unit-tests
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/__tests__/search-bar.test.tsx
  - src/components/__tests__/tag-filter.test.tsx
  - src/components/__tests__/pagination-controls.test.tsx
autonomous: true

must_haves:
  truths:
    - "SearchBar renders with defaultValue, debounces input by 300ms, and updates URL search params via router.push"
    - "TagFilter renders all tags, toggles active state on click, and updates URL params to add/remove tag slugs"
    - "PaginationControls hides when totalPages <= 1, renders correct page links, and builds correct href URLs with existing params"
  artifacts:
    - path: "src/components/__tests__/search-bar.test.tsx"
      provides: "SearchBar component tests"
      min_lines: 50
    - path: "src/components/__tests__/tag-filter.test.tsx"
      provides: "TagFilter component tests"
      min_lines: 50
    - path: "src/components/__tests__/pagination-controls.test.tsx"
      provides: "PaginationControls component tests"
      min_lines: 50
  key_links:
    - from: "src/components/__tests__/search-bar.test.tsx"
      to: "next/navigation"
      via: "vi.mock('next/navigation')"
      pattern: "vi\\.mock.*next/navigation"
    - from: "src/components/__tests__/tag-filter.test.tsx"
      to: "next/navigation"
      via: "vi.mock('next/navigation')"
      pattern: "vi\\.mock.*next/navigation"
---

<objective>
Write unit tests for the catalogue interactive components: SearchBar (debounced search), TagFilter (toggle tag selection), and PaginationControls (page navigation).

Purpose: Verify that user interactions in the recipe catalogue correctly update URL search parameters for server-side filtering and pagination.
Output: 3 test files covering the 3 catalogue interactive components.
</objective>

<execution_context>
@/Users/jimmydore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jimmydore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.1-comprehensive-unit-tests/04.1-RESEARCH.md

@src/components/search-bar.tsx
@src/components/tag-filter.tsx
@src/components/pagination-controls.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test SearchBar component with debounce behavior</name>
  <files>src/components/__tests__/search-bar.test.tsx</files>
  <action>
    Read `src/components/search-bar.tsx` to understand exact props, debounce mechanism, and how it calls router.push.

    Create test file with `next/navigation` mocked:
    ```tsx
    const mockPush = vi.fn();
    vi.mock("next/navigation", () => ({
      useRouter: () => ({ push: mockPush }),
      usePathname: () => "/recipes",
      useSearchParams: () => new URLSearchParams(""),
    }));
    ```

    **Tests:**
    - Renders input with defaultValue prop displayed
    - Renders input with empty string when no defaultValue
    - Does NOT call router.push immediately on input change (debounce)
    - Calls router.push after 300ms debounce with correct search param (use `vi.useFakeTimers()` + `vi.advanceTimersByTime(300)`)
    - Clears search param when input is emptied
    - Preserves existing URL params (e.g., tags) when updating search
    - New input within debounce period resets the timer (only latest value pushed)

    **Timer handling:**
    ```tsx
    beforeEach(() => {
      vi.useFakeTimers();
      mockPush.mockClear();
    });
    afterEach(() => {
      vi.useRealTimers();
    });
    ```

    Use `fireEvent.change` for input changes. Wrap `vi.advanceTimersByTime` and assertions in `act()` to handle React state updates:
    ```tsx
    import { render, screen, fireEvent, act } from "@testing-library/react";
    ```

    **Note:** The component uses `startTransition` which wraps the router.push call. After advancing timers, you may need `await act(async () => {})` to flush the transition.
  </action>
  <verify>
    Run `pnpm test run src/components/__tests__/search-bar.test.tsx` and verify all tests pass.
  </verify>
  <done>SearchBar tested with 5+ cases covering rendering, debounce timing, param building, and timer reset.</done>
</task>

<task type="auto">
  <name>Task 2: Test TagFilter and PaginationControls components</name>
  <files>src/components/__tests__/tag-filter.test.tsx, src/components/__tests__/pagination-controls.test.tsx</files>
  <action>
    Read `src/components/tag-filter.tsx` and `src/components/pagination-controls.tsx` to understand props, rendering logic, and URL param construction.

    **tag-filter.test.tsx:**
    Mock `next/navigation` same pattern as SearchBar.

    Tests:
    - Renders nothing (or empty container) when tags array is empty
    - Renders all tag names when tags provided
    - Inactive tags rendered without active styling
    - Active tags (matching activeSlugs) rendered with active styling (check className or aria attribute)
    - Clicking inactive tag calls router.push with tag slug added to URL params
    - Clicking active tag calls router.push with tag slug removed from URL params
    - Multiple active tags: toggling one preserves the others
    - Resets page to 1 when toggling tags (if component does this)

    **pagination-controls.test.tsx:**
    Read the component to understand if it uses `<Link>` components with href or router.push. Mock `next/navigation` accordingly.

    Tests:
    - Returns null (renders nothing) when totalPages <= 1
    - Renders page 1 as current (non-clickable or styled differently) when on page 1
    - Renders correct number of page links for totalPages=5
    - Page links have correct href with page param
    - Preserves existing search params (search, tags) in page links
    - Previous button disabled/hidden on page 1
    - Next button disabled/hidden on last page
    - Previous and Next buttons have correct hrefs when enabled

    **Note:** If PaginationControls uses `<Link>` from `next/link`, you may need to mock it too or render with a simple wrapper.
  </action>
  <verify>
    Run `pnpm test run src/components/__tests__/tag-filter.test.tsx src/components/__tests__/pagination-controls.test.tsx` and verify all tests pass.
  </verify>
  <done>TagFilter tested with 6+ cases covering rendering, toggle on/off, multiple active tags. PaginationControls tested with 6+ cases covering hide logic, page links, param preservation, and nav buttons.</done>
</task>

</tasks>

<verification>
```bash
# All catalogue component tests pass
pnpm test run src/components/__tests__/search-bar.test.tsx src/components/__tests__/tag-filter.test.tsx src/components/__tests__/pagination-controls.test.tsx
```
</verification>

<success_criteria>
- 3 test files exist in src/components/__tests__/
- All tests pass
- 15+ total assertions across the 3 files
- Debounce behavior tested with fake timers
- URL param construction verified for all components
- Edge cases (empty tags, single page, no search) covered
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-comprehensive-unit-tests/04.1-05-SUMMARY.md`
</output>
