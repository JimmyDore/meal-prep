---
phase: 03.1-pipeline-enrichment-optimization
plan: 02
subsystem: pipeline
tags: [claude-cli, batch-enrichment, recipe-assembly, two-stage-pipeline, jsonl, resumability]

# Dependency graph
requires:
  - phase: 03.1-01
    provides: "Ingredient extractor, batch enrichment functions, IngredientMacro type"
  - phase: 02-data-pipeline
    provides: "Claude CLI enricher, Zod schemas, JSONL utilities, scraped recipe data"
provides:
  - "loadMacroLookup for loading ingredient reference into Map"
  - "assembleEnrichedRecipe for joining macros to scraped recipes"
  - "Two-stage enrich.ts orchestrator replacing per-recipe enrichment"
  - "ingredient-macros.jsonl reference file format"
affects: [pipeline-execution, upload-pipeline]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Two-stage pipeline: extract-enrich-reference, then assemble-validate-output"
    - "JSONL reference file as intermediate artifact between pipeline stages"
    - "Map-based lookup for O(1) ingredient macro joins"

key-files:
  created:
    - scripts/pipeline/lib/recipe-assembler.ts
  modified:
    - scripts/pipeline/enrich.ts

key-decisions:
  - "crossValidateNutrition imported directly in enrich.ts orchestrator (not re-exported from recipe-assembler)"
  - "Missing ingredients produce partial enriched recipes with _flags rather than dropping entire recipe"
  - "--stage flag allows running Stage 1 or Stage 2 independently for debugging and re-assembly"

patterns-established:
  - "Two-stage pipeline: deduplicate -> enrich unique -> join back to source records"
  - "Resumability via Set-based skip on both stages (ingredient names for Stage 1, jowIds for Stage 2)"

# Metrics
duration: 3min
completed: 2026-02-08
---

# Phase 3.1 Plan 02: Two-Stage Pipeline Orchestrator Summary

**Recipe assembler module and rewritten enrich.ts as two-stage pipeline: batch-enrich unique ingredients to reference file, then assemble enriched recipes by joining macros back**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-08T19:33:49Z
- **Completed:** 2026-02-08T19:36:49Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments

- Recipe assembler loads ingredient-macros.jsonl into Map and joins macros to scraped recipes
- Handles missing ingredients gracefully: partial assembly with tracking, null return if all missing
- enrich.ts rewritten as two-stage orchestrator with full CLI flag support
- Stage 1: extracts unique ingredients, batches by configurable size, enriches via Claude CLI, writes reference JSONL
- Stage 2: loads macro lookup, assembles enriched recipes, cross-validates against Jow nutrition, writes output JSONL
- Both stages fully resumable (skip already-processed items)
- ~47 Claude CLI calls instead of ~3213 (99% reduction, ~24min vs ~27h)

## Task Commits

Each task was committed atomically:

1. **Task 1: Create recipe assembler module** - `d168e80` (feat)
2. **Task 2: Rewrite enrich.ts as two-stage pipeline** - `fed69fe` (feat)

## Files Created/Modified

- `scripts/pipeline/lib/recipe-assembler.ts` - loadMacroLookup (JSONL -> Map) and assembleEnrichedRecipe (join macros to recipe, track missing ingredients)
- `scripts/pipeline/enrich.ts` - Two-stage pipeline orchestrator with Stage 1 (batch ingredient enrichment) and Stage 2 (recipe assembly with cross-validation)

## Decisions Made

- `crossValidateNutrition` imported directly in enrich.ts rather than re-exported from recipe-assembler -- keeps assembler module focused on data joining, validation is orchestrator concern
- Missing ingredients produce partial enriched recipes with `incomplete_ingredients` flag and the missing names logged as warnings -- better than dropping entire recipes
- `--stage` flag enables independent Stage 1/Stage 2 execution for debugging and re-assembly without re-enriching
- Progress logging at every 5 batches (Stage 1) and every 500 recipes (Stage 2) for appropriate granularity
- Test data cleaned up after verification (ingredient-macros.jsonl and appended enriched entries removed)

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Verification Results

1. `pnpm check` passes (Biome lint + format)
2. Stage 1 tested: `--stage 1 --limit 1 --batch-size 1 --no-delay` enriched 1 ingredient via Claude CLI
3. `ingredient-macros.jsonl` created with valid EnrichedIngredient entry
4. Stage 2 tested: `--stage 2 --no-delay` assembled recipes from reference file
5. Output format verified: enrichedIngredients array, _flags for incomplete, same keys as EnrichedRecipe
6. Resumability verified: re-running Stage 1 skipped already-enriched ingredient, Stage 2 skipped already-assembled recipes
7. Upload pipeline compatibility: output JSONL matches EnrichedRecipe interface exactly

## Next Phase Readiness

- Phase 3.1 is complete: two-stage pipeline ready for full-scale execution
- To run full enrichment: `pnpm tsx scripts/pipeline/enrich.ts --no-delay` (both stages, ~47 batches, ~24 min)
- To re-assemble without re-enriching: `pnpm tsx scripts/pipeline/enrich.ts --stage 2 --no-delay`
- Upload pipeline works unchanged with new output format

---
*Phase: 03.1-pipeline-enrichment-optimization*
*Completed: 2026-02-08*
