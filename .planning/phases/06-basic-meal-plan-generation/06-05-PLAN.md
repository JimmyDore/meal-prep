---
phase: 06-basic-meal-plan-generation
plan: 05
type: execute
wave: 4
depends_on: ["06-04"]
files_modified:
  - src/app/(authenticated)/plan/page.tsx
  - src/app/(authenticated)/plan/loading.tsx
  - src/app/(authenticated)/plan/plan-client.tsx
  - src/components/meal-plan/weekly-grid.tsx
  - src/components/meal-plan/meal-slot-card.tsx
  - src/components/meal-plan/daily-summary.tsx
  - src/components/meal-plan/weekly-summary.tsx
  - src/components/meal-plan/match-badge.tsx
autonomous: false

must_haves:
  truths:
    - "User can click 'Generer mon plan' and see a weekly meal plan with 14 recipe cards"
    - "Weekly grid shows 7 days (Lun-Dim) with 2 rows (Midi/Soir) per day"
    - "Each recipe card shows title and match badge, expands to show macros and ingredients"
    - "Daily summary row shows actual vs target macros with delta per day"
    - "Weekly summary shows progress bars for P/G/L/Cal actual vs target"
    - "User can click 'Regenerer' to get a different plan"
    - "User can click 'Sauvegarder' to persist the plan to DB"
    - "Mobile view uses horizontal scroll with snap instead of 7-column grid"
  artifacts:
    - path: "src/app/(authenticated)/plan/page.tsx"
      provides: "Server component: loads profile, checks auth, renders PlanClient"
      min_lines: 20
    - path: "src/app/(authenticated)/plan/plan-client.tsx"
      provides: "Client component: generation trigger, state management, grid rendering"
      min_lines: 80
    - path: "src/components/meal-plan/weekly-grid.tsx"
      provides: "7-column CSS Grid layout for desktop, horizontal scroll for mobile"
      min_lines: 40
    - path: "src/components/meal-plan/meal-slot-card.tsx"
      provides: "Expandable recipe card with collapsible macro detail"
      min_lines: 40
    - path: "src/components/meal-plan/daily-summary.tsx"
      provides: "Daily macro actual vs target with delta display"
      min_lines: 30
    - path: "src/components/meal-plan/weekly-summary.tsx"
      provides: "Weekly progress bars P/G/L/Cal with match badge"
      min_lines: 40
    - path: "src/components/meal-plan/match-badge.tsx"
      provides: "Color-coded match percentage badge"
      min_lines: 15
  key_links:
    - from: "src/app/(authenticated)/plan/plan-client.tsx"
      to: "src/app/actions/meal-plan.ts"
      via: "calls generatePlan and savePlan server actions"
      pattern: "import.*(generatePlan|savePlan).*from.*actions/meal-plan"
    - from: "src/app/(authenticated)/plan/plan-client.tsx"
      to: "src/components/meal-plan/weekly-grid.tsx"
      via: "renders WeeklyGrid with plan data"
      pattern: "import.*WeeklyGrid.*from.*meal-plan"
    - from: "src/components/meal-plan/weekly-grid.tsx"
      to: "src/components/meal-plan/meal-slot-card.tsx"
      via: "renders MealSlotCard for each slot in the grid"
      pattern: "import.*MealSlotCard"
    - from: "src/components/meal-plan/weekly-grid.tsx"
      to: "src/components/meal-plan/daily-summary.tsx"
      via: "renders DailySummary below each day column"
      pattern: "import.*DailySummary"
---

<objective>
Build the /plan page UI with a 7-column weekly grid, expandable recipe cards, daily and weekly macro summaries, and generation/save controls.

Purpose: This is the main user-facing feature of Phase 6 -- the meal plan page where users generate, review, and save their weekly plan.
Output: Server component page, client component with state management, and 5 reusable meal-plan UI components.
</objective>

<execution_context>
@/Users/jimmydore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jimmydore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-basic-meal-plan-generation/06-CONTEXT.md
@.planning/phases/06-basic-meal-plan-generation/06-RESEARCH.md
@.planning/phases/06-basic-meal-plan-generation/06-04-SUMMARY.md
@src/app/(authenticated)/dashboard/page.tsx
@src/app/(authenticated)/layout.tsx
@src/app/actions/meal-plan.ts
@src/lib/meal-plan/types.ts
@src/lib/meal-plan/constants.ts
@src/components/header.tsx
@src/components/ui/card.tsx
@src/components/ui/button.tsx
@src/components/ui/progress.tsx
@src/components/ui/collapsible.tsx
@src/components/ui/tooltip.tsx
@src/components/ui/skeleton.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create meal plan UI components</name>
  <files>
    src/components/meal-plan/match-badge.tsx
    src/components/meal-plan/meal-slot-card.tsx
    src/components/meal-plan/daily-summary.tsx
    src/components/meal-plan/weekly-summary.tsx
    src/components/meal-plan/weekly-grid.tsx
  </files>
  <action>
    Create 5 components in `src/components/meal-plan/`. All are client components (`"use client"`) since they use interactivity (collapsible, tooltip).

    **1. match-badge.tsx** -- Color-coded score badge:
    ```tsx
    import { matchColor } from "@/lib/meal-plan";
    // Props: { score: number, size?: "sm" | "md" }
    // Renders: a small badge with "{score}%" text
    // Colors based on matchColor(score):
    //   green -> bg-green-100 text-green-700 border-green-200
    //   yellow -> bg-amber-100 text-amber-700 border-amber-200
    //   red -> bg-red-100 text-red-700 border-red-200
    // Size "sm" for recipe cards (text-xs px-1.5 py-0.5), "md" for plan-level (text-sm px-2 py-1)
    ```

    **2. meal-slot-card.tsx** -- Expandable recipe card:
    ```tsx
    import { Collapsible, CollapsibleContent, CollapsibleTrigger } from "@/components/ui/collapsible";
    import { Card, CardContent } from "@/components/ui/card";
    import { MatchBadge } from "./match-badge";
    // Props: { slot: MealSlot, dailyTarget: { calories, protein, carbs, fat } }
    // Renders: Card with recipe title (line-clamp-2) + MatchBadge
    // CollapsibleContent: macros per serving (P/G/L/Cal in a small grid), delta vs daily target / MEALS_PER_DAY
    //   Show delta: e.g. "+5g P" in green or "-10g P" in red
    //   Use Tooltip to explain "Ecart par rapport a la cible par repas"
    // Card has hover:shadow-md transition
    // Compute per-meal target = dailyTarget / MEALS_PER_DAY for delta display
    ```

    **3. daily-summary.tsx** -- Daily macro summary row:
    ```tsx
    // Props: { slots: MealSlot[] (2 slots for this day), dailyTarget: MacroTargets }
    // Sum the 2 slots' macros to get daily actual
    // Display a compact row: Cal: actual/target | P: actual/target | G: actual/target | L: actual/target
    // Color each: green if within 10% of daily target, amber if within 20%, red if beyond
    // Use text-xs for compact display
    ```

    **4. weekly-summary.tsx** -- Weekly progress bars:
    ```tsx
    import { Progress } from "@/components/ui/progress";
    import { MatchBadge } from "./match-badge";
    // Props: { score: PlanScore, weeklyTargets: WeeklyMacroTargets, warnings: string[] }
    // Layout: Card with:
    //   - Overall match: MatchBadge (size="md") with "{score.overall}% de correspondance"
    //   - 4 progress bars (Proteines, Glucides, Lipides, Calories):
    //     Label | actual/target | Progress bar (value = percentage, max 100)
    //     Show delta: "+Xg" or "-Xg" next to each bar
    //     Bar color: green/amber/red based on the macroScore.percentage
    //   - Warnings: if any, show in an amber alert box below
    // Progress bar value = Math.min(100, (actual / target) * 100) to avoid overflow
    // Use Tailwind utility classes for progress bar colors (override via className on Progress)
    ```

    **5. weekly-grid.tsx** -- The main grid layout:
    ```tsx
    // Props: { plan: PlanResult, dailyTargets: MacroTargets, weeklyTargets: WeeklyMacroTargets }
    // Day labels: ["Lun", "Mar", "Mer", "Jeu", "Ven", "Sam", "Dim"]
    // Full day labels for mobile: ["Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi", "Dimanche"]

    // Desktop layout (hidden below lg, shown as lg:grid):
    //   CSS Grid: grid-cols-7, gap-2
    //   Row 1: Day headers (Lun-Dim) in bold
    //   Row 2: Midi slots (one MealSlotCard per day)
    //   Label "Midi" in muted text on the left or above
    //   Row 3: Soir slots (one MealSlotCard per day)
    //   Label "Soir" in muted text on the left or above
    //   Row 4: DailySummary per day

    // Mobile layout (shown below lg, hidden at lg+):
    //   Horizontal scroll with snap: flex gap-4 overflow-x-auto snap-x snap-mandatory
    //   Each day is a min-w-[280px] snap-center card containing:
    //     Day name (full), Midi card, Soir card, DailySummary

    // Extract slots per day: plan.slots.filter(s => s.dayIndex === dayIdx)
    // Pass dailyTargets to each MealSlotCard and DailySummary
    ```

    Import types from `@/lib/meal-plan` (MealSlot, PlanScore, PlanResult, WeeklyMacroTargets, MEALS_PER_DAY).
    Import MacroTargets from `@/lib/nutrition`.
  </action>
  <verify>
    - `pnpm check` passes
    - `pnpm build` passes
    - All 5 component files exist in src/components/meal-plan/
  </verify>
  <done>
    Five meal plan UI components created: MatchBadge (color-coded score), MealSlotCard (expandable recipe card), DailySummary (daily macro row), WeeklySummary (progress bars), WeeklyGrid (responsive 7-column grid).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create /plan page with generation flow</name>
  <files>
    src/app/(authenticated)/plan/page.tsx
    src/app/(authenticated)/plan/loading.tsx
    src/app/(authenticated)/plan/plan-client.tsx
  </files>
  <action>
    **1. page.tsx** -- Server component (follows dashboard/page.tsx pattern):
    ```tsx
    import type { Metadata } from "next";
    import { headers } from "next/headers";
    import { redirect } from "next/navigation";
    import { auth } from "@/lib/auth";
    import { getFullUserProfile } from "@/db/queries/profiles";
    import { calculateBMR, calculateTDEE, calculateMacroTargets } from "@/lib/nutrition";
    import { dailyToWeekly } from "@/lib/meal-plan";
    import { PlanClient } from "./plan-client";

    export const metadata: Metadata = { title: "Mon plan | Meal Prep" };

    export default async function PlanPage() {
      // Auth + profile check (same pattern as dashboard)
      const session = await auth.api.getSession({ headers: await headers() });
      if (!session) redirect("/auth");

      const { profile, sportActivities } = await getFullUserProfile(session.user.id);

      // Check profile completeness
      if (!profile || profile.weight === null || ... ) {
        // Show "Profil incomplet" card with link to /settings/profile (same pattern as dashboard)
        return (...);
      }

      // Compute targets server-side (same chain as dashboard)
      const bmr = calculateBMR({ weight: profile.weight, height: profile.height, age: profile.age, sex: profile.sex });
      const sportSessions = sportActivities.map(sa => ({ activityType: sa.activityType, weeklyFrequency: sa.weeklyFrequency }));
      const tdee = calculateTDEE(bmr, { weight: profile.weight, activityLevel: profile.activityLevel }, sportSessions);
      const dailyTargets = calculateMacroTargets(tdee, { weight: profile.weight, goal: profile.goal });
      const weeklyTargets = dailyToWeekly(dailyTargets);

      return (
        <div className="mx-auto max-w-7xl px-4 py-8">
          <h1 className="mb-6 text-2xl font-bold">Mon plan de la semaine</h1>
          <PlanClient dailyTargets={dailyTargets} weeklyTargets={weeklyTargets} />
        </div>
      );
    }
    ```
    Use max-w-7xl (wider than dashboard's max-w-2xl) to fit the 7-column grid.

    **2. loading.tsx** -- Skeleton loading state:
    ```tsx
    import { Skeleton } from "@/components/ui/skeleton";
    // Show: title skeleton + 7-column grid of skeleton cards (same structure as WeeklyGrid but with Skeleton instead of data)
    ```

    **3. plan-client.tsx** -- Client component with state management:
    ```tsx
    "use client";

    import { useState, useTransition } from "react";
    import { toast } from "sonner";
    import { Button } from "@/components/ui/button";
    import { Skeleton } from "@/components/ui/skeleton";
    import { RefreshCw, Save, Sparkles } from "lucide-react";
    import { generatePlan, savePlan } from "@/app/actions/meal-plan";
    import { WeeklyGrid } from "@/components/meal-plan/weekly-grid";
    import { WeeklySummary } from "@/components/meal-plan/weekly-summary";
    import type { PlanResult, WeeklyMacroTargets } from "@/lib/meal-plan";
    import type { MacroTargets } from "@/lib/nutrition";

    interface PlanClientProps {
      dailyTargets: MacroTargets;
      weeklyTargets: WeeklyMacroTargets;
    }

    export function PlanClient({ dailyTargets, weeklyTargets }: PlanClientProps) {
      const [plan, setPlan] = useState<PlanResult | null>(null);
      const [isGenerating, startGenerate] = useTransition();
      const [isSaving, startSave] = useTransition();
      const [isSaved, setIsSaved] = useState(false);

      function handleGenerate() {
        setIsSaved(false);
        startGenerate(async () => {
          const result = await generatePlan();
          if ("error" in result) {
            toast.error(result.error);
            return;
          }
          setPlan(result.plan);
        });
      }

      function handleSave() {
        if (!plan) return;
        startSave(async () => {
          // Compute weekStart as next Monday ISO date
          const today = new Date();
          const dayOfWeek = today.getDay(); // 0=Sun, 1=Mon
          const daysUntilMonday = dayOfWeek === 0 ? 1 : dayOfWeek === 1 ? 0 : 8 - dayOfWeek;
          const nextMonday = new Date(today);
          nextMonday.setDate(today.getDate() + daysUntilMonday);
          const weekStart = nextMonday.toISOString().split("T")[0];

          // Sum actual macros from plan slots
          const actual = plan.slots.reduce(
            (acc, slot) => ({
              calories: acc.calories + slot.recipe.perServing.calories,
              protein: acc.protein + slot.recipe.perServing.protein,
              carbs: acc.carbs + slot.recipe.perServing.carbs,
              fat: acc.fat + slot.recipe.perServing.fat,
            }),
            { calories: 0, protein: 0, carbs: 0, fat: 0 },
          );

          const result = await savePlan({
            weekStart,
            overallScore: plan.score.overall,
            macroSummary: { target: weeklyTargets, actual },
            slots: plan.slots.map(slot => ({
              dayIndex: slot.dayIndex,
              mealType: slot.mealType,
              recipeId: slot.recipe.id,
              macrosSnapshot: slot.recipe.perServing,
            })),
          });

          if ("error" in result) {
            toast.error(result.error);
          } else {
            toast.success("Plan sauvegarde !");
            setIsSaved(true);
          }
        });
      }

      // Empty state -- no plan generated yet
      if (!plan && !isGenerating) {
        return (
          <div className="flex flex-col items-center justify-center rounded-lg border-2 border-dashed py-20">
            <Sparkles className="mb-4 size-12 text-muted-foreground" />
            <h2 className="mb-2 text-lg font-semibold">Aucun plan genere</h2>
            <p className="mb-6 text-sm text-muted-foreground">
              Generez un plan de repas optimise pour vos objectifs macros
            </p>
            <Button onClick={handleGenerate} size="lg">
              <Sparkles className="size-4" />
              Generer mon plan
            </Button>
          </div>
        );
      }

      // Loading state -- generation in progress
      if (isGenerating) {
        return (
          <div className="space-y-4">
            <div className="flex items-center gap-2 text-sm text-muted-foreground">
              <RefreshCw className="size-4 animate-spin" />
              Generation en cours...
            </div>
            {/* Skeleton grid: 7 columns, 2 rows of skeleton cards */}
            <div className="hidden lg:grid lg:grid-cols-7 lg:gap-2">
              {Array.from({ length: 14 }).map((_, i) => (
                <Skeleton key={i} className="h-24 rounded-lg" />
              ))}
            </div>
            <div className="flex gap-4 overflow-x-auto lg:hidden">
              {Array.from({ length: 3 }).map((_, i) => (
                <Skeleton key={i} className="h-48 min-w-[280px] rounded-lg" />
              ))}
            </div>
          </div>
        );
      }

      // Plan generated -- show grid + controls
      return (
        <div className="space-y-6">
          {/* Action bar */}
          <div className="flex flex-wrap items-center gap-3">
            <Button onClick={handleGenerate} variant="outline" disabled={isGenerating}>
              <RefreshCw className="size-4" />
              Regenerer
            </Button>
            <Button onClick={handleSave} disabled={isSaving || isSaved}>
              <Save className="size-4" />
              {isSaved ? "Sauvegarde" : isSaving ? "Sauvegarde..." : "Sauvegarder"}
            </Button>
          </div>

          {/* Weekly summary */}
          {plan && (
            <WeeklySummary
              score={plan.score}
              weeklyTargets={weeklyTargets}
              warnings={plan.warnings}
            />
          )}

          {/* Weekly grid */}
          {plan && (
            <WeeklyGrid
              plan={plan}
              dailyTargets={dailyTargets}
              weeklyTargets={weeklyTargets}
            />
          )}
        </div>
      );
    }
    ```

    Key UX decisions per CONTEXT.md:
    - Plan is NOT auto-saved. "Sauvegarder" button persists to DB.
    - "Regenerer" creates a completely new plan (full reshuffle).
    - One-click generation with immediate preview (per RESEARCH.md discretion resolution).
    - Loading state shows skeleton grid + spinning icon.
    - Toast notifications via sonner for save success/error.
  </action>
  <verify>
    - `pnpm check` passes
    - `pnpm build` passes
    - Navigating to /plan (when logged in with complete profile) shows the empty state with "Generer mon plan" button
  </verify>
  <done>
    /plan page renders with auth protection, profile check, empty state CTA, generation with loading skeleton, plan display with 7-column responsive grid, regenerate and save controls. Weekly summary shows progress bars. Daily summaries show per-day macro fit.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete meal plan generation feature:
    - Scoring module with weighted macro matching (Plan 01)
    - DB schema with meal_plans + meal_plan_slots tables (Plan 02)
    - Random-restart hill-climbing generation algorithm (Plan 03)
    - Server actions for generate + save (Plan 04)
    - /plan page with 7-column weekly grid, expandable cards, macro summaries (Plan 05)
    - Header "Mon plan" nav link
  </what-built>
  <how-to-verify>
    1. Start dev server: `pnpm dev`
    2. Log in and navigate to /plan (or click "Mon plan" in header dropdown)
    3. Verify empty state shows with "Generer mon plan" button
    4. Click "Generer mon plan" -- loading skeleton should appear briefly
    5. Plan appears: 7-day grid with 2 meals per day (Midi/Soir)
    6. Check the weekly summary: overall match score badge + P/G/L/Cal progress bars
    7. Click on a recipe card to expand it -- should show macros per serving and delta vs target
    8. Check daily summary rows below each day column
    9. Click "Regenerer" -- a different plan should appear
    10. Click "Sauvegarder" -- toast notification "Plan sauvegarde !"
    11. Resize browser to mobile width (<1024px) -- grid should switch to horizontal scroll
    12. Check DB: `docker compose exec -T db psql -U mealprep -d mealprep -c "SELECT id, overall_score FROM meal_plans ORDER BY created_at DESC LIMIT 1;"` should show the saved plan
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
- /plan page loads for authenticated users with complete profiles
- Generation produces 14 unique recipe slots in a 7-day grid
- Weekly summary shows overall match score and per-macro progress bars
- Recipe cards expand to show macro details
- Regeneration produces a different plan
- Save persists to DB successfully
- Mobile view is usable (horizontal scroll, not tiny columns)
- `pnpm test` still passes (existing tests not broken)
- `pnpm check` passes
</verification>

<success_criteria>
- User can generate a weekly meal plan (14 meals) in one click
- Plan displays in 7-column grid (desktop) / horizontal scroll (mobile)
- Each recipe card shows match badge and expands to show macros
- Daily and weekly summaries show actual vs target with visual indicators
- User can regenerate to get a different plan
- User can save the plan to DB
- Match score and progress bars accurately reflect algorithm output
</success_criteria>

<output>
After completion, create `.planning/phases/06-basic-meal-plan-generation/06-05-SUMMARY.md`
</output>
