---
phase: 06-basic-meal-plan-generation
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/lib/meal-plan/types.ts
  - src/lib/meal-plan/constants.ts
  - src/lib/meal-plan/score.ts
  - src/lib/meal-plan/index.ts
  - src/lib/meal-plan/__tests__/score.test.ts
autonomous: true

must_haves:
  truths:
    - "Scoring function produces a 0-100 percentage for any plan vs weekly macro targets"
    - "Score penalizes both over AND under target equally (symmetric deviation)"
    - "Weighted scoring prioritizes protein (30%) > calories (25%) > carbs (20%) > fat (15%) > variety (10%)"
    - "Match color thresholds: green >= 85, yellow >= 65, red < 65"
  artifacts:
    - path: "src/lib/meal-plan/types.ts"
      provides: "MealSlot, PlanResult, PlanScore, MacroScore, WeeklyMacroTargets, ScoredRecipe, GenerationParams, ScoringWeights types"
      min_lines: 40
    - path: "src/lib/meal-plan/constants.ts"
      provides: "DEFAULT_WEIGHTS, MATCH_THRESHOLDS, DAYS_PER_WEEK, MEALS_PER_DAY, default iteration/pass counts"
      min_lines: 20
    - path: "src/lib/meal-plan/score.ts"
      provides: "scorePlan, macroScore, matchColor, sumMacros, calculateVarietyScore, dailyToWeekly"
      exports: ["scorePlan", "macroScore", "matchColor", "sumMacros", "calculateVarietyScore", "dailyToWeekly"]
      min_lines: 60
    - path: "src/lib/meal-plan/__tests__/score.test.ts"
      provides: "Unit tests for all scoring functions"
      min_lines: 80
  key_links:
    - from: "src/lib/meal-plan/score.ts"
      to: "src/lib/meal-plan/types.ts"
      via: "imports MealSlot, PlanScore, MacroScore, WeeklyMacroTargets, ScoringWeights"
      pattern: "import.*from.*types"
    - from: "src/lib/meal-plan/score.ts"
      to: "src/lib/meal-plan/constants.ts"
      via: "imports DEFAULT_WEIGHTS"
      pattern: "import.*DEFAULT_WEIGHTS.*from.*constants"
---

<objective>
Create the meal plan scoring module -- types, constants, and scoring functions that evaluate how well a set of 14 recipes matches weekly macro targets.

Purpose: The scoring function is the core building block used by the generation algorithm (Plan 03) to evaluate candidate plans. It must be deterministic and independently testable.
Output: `src/lib/meal-plan/` module with types.ts, constants.ts, score.ts, index.ts, and comprehensive tests.
</objective>

<execution_context>
@/Users/jimmydore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jimmydore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-basic-meal-plan-generation/06-CONTEXT.md
@.planning/phases/06-basic-meal-plan-generation/06-RESEARCH.md
@src/lib/nutrition/types.ts
@src/lib/nutrition/index.ts
</context>

<feature>
  <name>Meal Plan Scoring Module</name>
  <files>
    src/lib/meal-plan/types.ts
    src/lib/meal-plan/constants.ts
    src/lib/meal-plan/score.ts
    src/lib/meal-plan/index.ts
    src/lib/meal-plan/__tests__/score.test.ts
  </files>
  <behavior>
    **types.ts** -- Define all types for the meal-plan module:
    - `WeeklyMacroTargets`: { calories, protein, carbs, fat } (all numbers, weekly totals)
    - `ScoredRecipe`: { id, title, perServing: { calories, protein, carbs, fat }, confidence: "high"|"medium"|"low", cuisine: string|null, category: string|null }
    - `MealSlot`: { dayIndex: number (0-6), mealType: "midi"|"soir", recipe: ScoredRecipe }
    - `MacroScore`: { target, actual, delta, percentage } (all numbers)
    - `PlanScore`: { overall: number, protein: MacroScore, carbs: MacroScore, fat: MacroScore, calories: MacroScore, variety: number }
    - `PlanResult`: { slots: MealSlot[], score: PlanScore, warnings: string[] }
    - `ScoringWeights`: { protein, calories, carbs, fat, variety } (all numbers summing to 1.0)
    - `GenerationParams`: { weeklyTargets: WeeklyMacroTargets, recipePool: ScoredRecipe[], iterations?: number, maxLocalPasses?: number, random?: () => number }
    - `MatchColor`: "green" | "yellow" | "red"

    **constants.ts** -- Define all constants:
    - `DAYS_PER_WEEK = 7`
    - `MEALS_PER_DAY = 2` (midi + soir, extractable constant for Phase 7)
    - `TOTAL_MEALS = DAYS_PER_WEEK * MEALS_PER_DAY` (= 14)
    - `DEFAULT_WEIGHTS: ScoringWeights = { protein: 0.30, calories: 0.25, carbs: 0.20, fat: 0.15, variety: 0.10 }`
    - `DEFAULT_ITERATIONS = 50`
    - `DEFAULT_MAX_LOCAL_PASSES = 3`
    - `MATCH_THRESHOLDS = { green: 85, yellow: 65 }` for matchColor
    - `DEVIATION_CEILING = 0.2` (20% deviation = score 0)

    **score.ts** -- Implement scoring functions:

    1. `dailyToWeekly(daily: MacroTargets): WeeklyMacroTargets` -- multiply each field by 7. Import MacroTargets from @/lib/nutrition.

    2. `macroScore(actual: number, target: number): MacroScore` -- Per-macro deviation score.
       - If target === 0: return { target: 0, actual, delta: actual, percentage: actual === 0 ? 100 : 0 }
       - delta = actual - target (positive = over, negative = under)
       - deviationRatio = Math.abs(delta) / target
       - percentage = max(0, min(100, round((1 - deviationRatio / DEVIATION_CEILING) * 100)))
       - So: 0% deviation = 100, 10% deviation = 50, 20%+ deviation = 0

    3. `sumMacros(slots: MealSlot[]): { calories, protein, carbs, fat }` -- Sum perServing macros across all slots.

    4. `calculateVarietyScore(slots: MealSlot[]): number` -- 0-100 score. Penalize consecutive slots (sorted by dayIndex then mealType) that share the same cuisine or category. If cuisine/category is null, skip that comparison (no penalty). Score = 100 - (duplicateCount / (totalSlots - 1)) * 100, clamped to 0-100.

    5. `scorePlan(slots: MealSlot[], weeklyTargets: WeeklyMacroTargets, weights?: ScoringWeights): PlanScore` -- Uses DEFAULT_WEIGHTS if weights not provided. Sums macros via sumMacros, computes each macroScore, computes varietyScore, weighted overall = round of sum of (score.percentage * weight).

    6. `matchColor(score: number): MatchColor` -- score >= 85 -> "green", >= 65 -> "yellow", else "red".

    **index.ts** -- Barrel export:
    - Export all from types.ts, score.ts, constants.ts

    Test cases:
    - `macroScore(700, 700)` -> { target: 700, actual: 700, delta: 0, percentage: 100 }
    - `macroScore(770, 700)` -> delta: 70, deviationRatio: 0.1, percentage: 50
    - `macroScore(560, 700)` -> delta: -140, deviationRatio: 0.2, percentage: 0
    - `macroScore(840, 700)` -> delta: 140, deviationRatio: 0.2, percentage: 0
    - `macroScore(0, 0)` -> percentage: 100
    - `macroScore(50, 0)` -> percentage: 0
    - `dailyToWeekly({ calories: 2500, protein: 150, carbs: 300, fat: 80 })` -> { calories: 17500, protein: 1050, carbs: 2100, fat: 560 }
    - `sumMacros` with 2 slots -> correct sums
    - `sumMacros` with empty array -> all zeros
    - `scorePlan` with perfect match -> overall: 100
    - `scorePlan` with 10% deviation on all macros -> overall: ~50 (weighted)
    - `matchColor(90)` -> "green", `matchColor(70)` -> "yellow", `matchColor(50)` -> "red"
    - `calculateVarietyScore` with no consecutive duplicates -> 100
    - `calculateVarietyScore` with all same cuisine -> low score
    - `calculateVarietyScore` with null cuisines -> no penalty
  </behavior>
  <implementation>
    Follow TDD red-green-refactor cycle:
    1. RED: Write all tests in score.test.ts first. Tests should import from the module files. Run `pnpm test src/lib/meal-plan` -- all tests MUST fail (files don't exist yet or functions not implemented).
    2. GREEN: Implement types.ts, constants.ts, score.ts, index.ts. Run tests -- all MUST pass.
    3. REFACTOR: Clean up if needed. Run tests -- still pass.

    Important:
    - Import `MacroTargets` from `@/lib/nutrition` for `dailyToWeekly` parameter type
    - All functions are pure (no DB, no React, no side effects)
    - Use `export interface` (not `export type`) per project convention
    - Round all scores to integers via Math.round
    - DEVIATION_CEILING of 0.2 means 20% deviation = 0 score -- this is deliberately aggressive to push the algorithm toward close matches
  </implementation>
</feature>

<verification>
- `pnpm test src/lib/meal-plan` passes all tests
- `pnpm check` passes (Biome lint + format)
- No imports from React, Next.js, or DB modules in src/lib/meal-plan/
</verification>

<success_criteria>
- macroScore correctly scores exact match as 100, 10% deviation as ~50, 20%+ deviation as 0
- scorePlan produces weighted overall score from individual macro scores
- matchColor returns correct color for each threshold range
- All scoring functions are pure, deterministic, and tested
- At least 15 test cases covering scoring, summing, variety, and edge cases
</success_criteria>

<output>
After completion, create `.planning/phases/06-basic-meal-plan-generation/06-01-SUMMARY.md`
</output>
