---
phase: 06-basic-meal-plan-generation
plan: 04
type: execute
wave: 3
depends_on: ["06-01", "06-02", "06-03"]
files_modified:
  - src/app/actions/meal-plan.ts
  - src/components/header.tsx
  - src/components/ui/progress.tsx
  - src/components/ui/collapsible.tsx
  - src/components/ui/tooltip.tsx
autonomous: true

must_haves:
  truths:
    - "generatePlan server action fetches user profile, computes targets, loads recipe pool, runs algorithm, returns PlanResult"
    - "savePlan server action persists the plan to DB with macro snapshot per slot"
    - "Both actions check auth and return error if not authenticated"
    - "Header has a 'Mon plan' link to /plan with CalendarDays icon"
    - "shadcn progress, collapsible, tooltip components are installed"
  artifacts:
    - path: "src/app/actions/meal-plan.ts"
      provides: "generatePlan and savePlan server actions"
      exports: ["generatePlan", "savePlan"]
      min_lines: 60
    - path: "src/components/header.tsx"
      provides: "Updated header with /plan link"
      contains: "CalendarDays"
  key_links:
    - from: "src/app/actions/meal-plan.ts"
      to: "src/lib/meal-plan/generate.ts"
      via: "imports generateMealPlan"
      pattern: "import.*generateMealPlan.*from.*meal-plan"
    - from: "src/app/actions/meal-plan.ts"
      to: "src/lib/nutrition"
      via: "imports calculateBMR, calculateTDEE, calculateMacroTargets, calculateRecipeMacros"
      pattern: "import.*from.*nutrition"
    - from: "src/app/actions/meal-plan.ts"
      to: "src/db/queries/meal-plans.ts"
      via: "imports getAllRecipesWithIngredients, saveMealPlan"
      pattern: "import.*from.*queries/meal-plans"
    - from: "src/app/actions/meal-plan.ts"
      to: "src/db/queries/profiles.ts"
      via: "imports getFullUserProfile"
      pattern: "import.*getFullUserProfile.*from.*queries/profiles"
---

<objective>
Create the server actions that bridge the generation algorithm with the database and UI, install new shadcn components, and add the /plan nav link.

Purpose: Server actions are the glue that connects the pure algorithm module with real DB data and auth. The header nav and shadcn components prepare the UI layer for Plan 05.
Output: Two server actions (generatePlan, savePlan), updated header, three new UI components.
</objective>

<execution_context>
@/Users/jimmydore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jimmydore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-basic-meal-plan-generation/06-CONTEXT.md
@.planning/phases/06-basic-meal-plan-generation/06-RESEARCH.md
@.planning/phases/06-basic-meal-plan-generation/06-01-SUMMARY.md
@.planning/phases/06-basic-meal-plan-generation/06-02-SUMMARY.md
@.planning/phases/06-basic-meal-plan-generation/06-03-SUMMARY.md
@src/app/actions/profile.ts
@src/db/queries/profiles.ts
@src/db/queries/meal-plans.ts
@src/lib/nutrition/index.ts
@src/lib/nutrition/types.ts
@src/lib/meal-plan/index.ts
@src/components/header.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create generatePlan and savePlan server actions</name>
  <files>src/app/actions/meal-plan.ts</files>
  <action>
    Create `src/app/actions/meal-plan.ts` with `"use server"` directive. Follow the exact pattern from `src/app/actions/profile.ts` for auth checking.

    **generatePlan()** server action:
    1. Get session via `auth.api.getSession({ headers: await headers() })`. Return `{ error: "Non authentifie" }` if no session.
    2. Load user profile: `const { profile, sportActivities } = await getFullUserProfile(session.user.id);`
    3. Validate profile has all required fields (weight, height, age, sex, activityLevel, goal). Return `{ error: "Profil incomplet" }` if not.
    4. Calculate macro chain:
       ```
       const bmr = calculateBMR({ weight, height, age, sex });
       const sportSessions = sportActivities.map(sa => ({ activityType: sa.activityType, weeklyFrequency: sa.weeklyFrequency }));
       const tdee = calculateTDEE(bmr, { weight, activityLevel }, sportSessions);
       const dailyTargets = calculateMacroTargets(tdee, { weight, goal });
       const weeklyTargets = dailyToWeekly(dailyTargets);
       ```
    5. Fetch recipe pool: `const allRecipes = await getAllRecipesWithIngredients();`
    6. Transform recipes into ScoredRecipe[]:
       ```
       const recipePool: ScoredRecipe[] = allRecipes.map(recipe => {
         const macros = calculateRecipeMacros(
           recipe.recipeIngredients.map(ri => ({
             name: ri.ingredient.name,
             quantity: ri.quantity,
             unit: ri.unit,
             caloriesPer100g: ri.ingredient.caloriesPer100g,
             proteinPer100g: ri.ingredient.proteinPer100g,
             carbsPer100g: ri.ingredient.carbsPer100g,
             fatPer100g: ri.ingredient.fatPer100g,
           })),
           recipe.originalPortions ?? 1,
         );
         return {
           id: recipe.id,
           title: recipe.title,
           perServing: macros.perServing,
           confidence: macros.confidence,
           cuisine: recipe.cuisine,
           category: recipe.category,
         };
       });
       ```
    7. Generate plan: `const plan = generateMealPlan({ weeklyTargets, recipePool });`
    8. Return: `{ success: true, plan, dailyTargets, weeklyTargets }`

    Return type: `Promise<{ success: true; plan: PlanResult; dailyTargets: MacroTargets; weeklyTargets: WeeklyMacroTargets } | { error: string }>`

    **savePlan(planData)** server action:
    1. Auth check (same pattern).
    2. Accept parameter:
       ```typescript
       interface SavePlanInput {
         weekStart: string;  // ISO date string
         overallScore: number;
         macroSummary: { target: WeeklyMacroTargets; actual: { calories: number; protein: number; carbs: number; fat: number } };
         slots: Array<{
           dayIndex: number;
           mealType: "midi" | "soir";
           recipeId: string;
           macrosSnapshot: { calories: number; protein: number; carbs: number; fat: number };
         }>;
       }
       ```
    3. Call `saveMealPlan` from queries with userId from session.
    4. Return `{ success: true, planId: result.id }` or `{ error: string }`.

    Wrap both actions in try/catch. Log errors with `console.error`. Return French error messages.

    Imports:
    - `headers` from `next/headers`
    - `auth` from `@/lib/auth`
    - `getFullUserProfile` from `@/db/queries/profiles`
    - `getAllRecipesWithIngredients, saveMealPlan` from `@/db/queries/meal-plans`
    - `calculateBMR, calculateTDEE, calculateMacroTargets, calculateRecipeMacros` from `@/lib/nutrition`
    - `generateMealPlan, dailyToWeekly` from `@/lib/meal-plan`
    - Types: `ScoredRecipe, PlanResult, WeeklyMacroTargets` from `@/lib/meal-plan`
    - `MacroTargets` from `@/lib/nutrition`
  </action>
  <verify>
    - `pnpm check` passes
    - `pnpm build` passes (server action compiles, types resolve)
  </verify>
  <done>
    generatePlan server action runs the full chain: auth -> profile -> BMR -> TDEE -> macroTargets -> dailyToWeekly -> fetchRecipes -> calculateRecipeMacros -> generateMealPlan -> return plan. savePlan persists to DB via transactional insert.
  </done>
</task>

<task type="auto">
  <name>Task 2: Install shadcn components and update header nav</name>
  <files>
    src/components/header.tsx
    src/components/ui/progress.tsx
    src/components/ui/collapsible.tsx
    src/components/ui/tooltip.tsx
  </files>
  <action>
    **1. Install shadcn components:**
    Run: `pnpm dlx shadcn@latest add progress collapsible tooltip`

    This creates three new files in `src/components/ui/`. Verify they exist after install.

    **2. Update header with /plan link:**
    Edit `src/components/header.tsx`:
    - Add `CalendarDays` to the lucide-react import: `import { Calculator, CalendarDays, LogOut, User } from "lucide-react";`
    - Add a new DropdownMenuItem BEFORE "Mes macros":
      ```tsx
      <DropdownMenuItem asChild>
        <Link href="/plan">
          <CalendarDays className="size-4" />
          Mon plan
        </Link>
      </DropdownMenuItem>
      ```
    - Keep existing items (Mes macros, Mon profil, Se deconnecter) in their current order.
    - Final order: Mon plan, Mes macros, Mon profil, separator, Se deconnecter.
  </action>
  <verify>
    - `ls src/components/ui/progress.tsx src/components/ui/collapsible.tsx src/components/ui/tooltip.tsx` -- all three exist
    - `pnpm check` passes
    - `pnpm build` passes
  </verify>
  <done>
    Three new shadcn components installed. Header dropdown has "Mon plan" link with CalendarDays icon pointing to /plan.
  </done>
</task>

</tasks>

<verification>
- `pnpm check` passes
- `pnpm build` passes
- Server actions properly import from meal-plan module, nutrition module, and DB queries
- Header renders "Mon plan" link in dropdown
</verification>

<success_criteria>
- generatePlan action chains: auth -> profile -> BMR -> TDEE -> targets -> recipes -> algorithm -> result
- savePlan action persists plan + slots to DB in a transaction
- Both actions handle auth failure and return French error messages
- shadcn progress, collapsible, tooltip components installed
- Header dropdown includes "Mon plan" link to /plan
</success_criteria>

<output>
After completion, create `.planning/phases/06-basic-meal-plan-generation/06-04-SUMMARY.md`
</output>
