---
phase: 06-basic-meal-plan-generation
plan: 03
type: tdd
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/lib/meal-plan/generate.ts
  - src/lib/meal-plan/index.ts
  - src/lib/meal-plan/__tests__/generate.test.ts
autonomous: true

must_haves:
  truths:
    - "generateMealPlan selects 14 unique recipes from the pool optimized for weekly macro targets"
    - "Algorithm uses random-restart hill-climbing: N random candidate plans, keep best, then local swaps"
    - "Seeded random function makes algorithm deterministic in tests"
    - "Algorithm produces warnings when recipe pool < 30 or < 14"
    - "Each slot has a dayIndex (0-6) and mealType (midi/soir) correctly assigned"
  artifacts:
    - path: "src/lib/meal-plan/generate.ts"
      provides: "generateMealPlan function -- core algorithm"
      exports: ["generateMealPlan"]
      min_lines: 80
    - path: "src/lib/meal-plan/__tests__/generate.test.ts"
      provides: "Unit tests for generation algorithm"
      min_lines: 80
  key_links:
    - from: "src/lib/meal-plan/generate.ts"
      to: "src/lib/meal-plan/score.ts"
      via: "imports scorePlan to evaluate candidate plans"
      pattern: "import.*scorePlan.*from.*score"
    - from: "src/lib/meal-plan/generate.ts"
      to: "src/lib/meal-plan/types.ts"
      via: "imports GenerationParams, PlanResult, MealSlot, ScoredRecipe"
      pattern: "import.*from.*types"
    - from: "src/lib/meal-plan/generate.ts"
      to: "src/lib/meal-plan/constants.ts"
      via: "imports DEFAULT_ITERATIONS, DEFAULT_MAX_LOCAL_PASSES, TOTAL_MEALS, MEALS_PER_DAY"
      pattern: "import.*from.*constants"
---

<objective>
Implement the random-restart hill-climbing meal plan generation algorithm that selects 14 unique recipes optimized for weekly macro targets.

Purpose: This is the core algorithm that powers the "Generer un plan" feature. It must be fast (<100ms), produce good macro matches, and be deterministic when seeded for testing.
Output: `src/lib/meal-plan/generate.ts` with comprehensive tests.
</objective>

<execution_context>
@/Users/jimmydore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jimmydore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-basic-meal-plan-generation/06-CONTEXT.md
@.planning/phases/06-basic-meal-plan-generation/06-RESEARCH.md
@.planning/phases/06-basic-meal-plan-generation/06-01-SUMMARY.md
@src/lib/meal-plan/types.ts
@src/lib/meal-plan/constants.ts
@src/lib/meal-plan/score.ts
</context>

<feature>
  <name>Meal Plan Generation Algorithm</name>
  <files>
    src/lib/meal-plan/generate.ts
    src/lib/meal-plan/index.ts
    src/lib/meal-plan/__tests__/generate.test.ts
  </files>
  <behavior>
    **generateMealPlan(params: GenerationParams): PlanResult**

    Algorithm (random-restart hill-climbing with local optimization):

    1. **Validate inputs:**
       - If recipePool.length < 14: generate with available recipes, add warning "Seulement {N} recettes disponibles, le plan sera incomplet"
       - If recipePool.length < 30: add warning "Moins de 30 recettes disponibles, la variete sera limitee"
       - If recipePool.length === 0: return empty plan with score 0 and warning

    2. **Pre-filter recipe pool:**
       - Only include recipes with confidence !== "low" (medium or high confidence macros)
       - If filtered pool < 14 but original pool >= 14, fall back to original pool with warning "Certaines recettes ont des macros peu fiables"

    3. **Random restart phase** (params.iterations times, default 50):
       a. Randomly sample min(14, poolSize) unique recipes from the pool using params.random (default Math.random)
       b. Assign to slots: dayIndex 0-6, mealType alternating "midi" then "soir" for each day
       c. Score the candidate plan via scorePlan(slots, params.weeklyTargets)
       d. If score.overall > bestScore: keep as best candidate

    4. **Local optimization phase** (params.maxLocalPasses times, default 3):
       a. For each slot in the best plan:
          - For each unused recipe in the pool (not already in the plan):
            - Try swapping the slot's recipe with the unused recipe
            - Score the new plan
            - If improved: keep the swap, mark old recipe as available
       b. If no swaps improved the plan in this pass: stop early

    5. **Build result:**
       - Return { slots: bestSlots, score: bestScore, warnings }

    **Slot assignment helper:**
    ```
    function assignSlots(recipes: ScoredRecipe[]): MealSlot[] {
      return recipes.map((recipe, i) => ({
        dayIndex: Math.floor(i / MEALS_PER_DAY),  // 0,0,1,1,2,2,...,6,6
        mealType: (i % MEALS_PER_DAY === 0 ? "midi" : "soir") as "midi" | "soir",
        recipe,
      }));
    }
    ```

    **Random sampling helper:**
    ```
    function sampleUnique<T>(array: T[], count: number, random: () => number): T[] {
      const copy = [...array];
      const result: T[] = [];
      for (let i = 0; i < Math.min(count, copy.length); i++) {
        const idx = Math.floor(random() * copy.length);
        result.push(copy.splice(idx, 1)[0]);
      }
      return result;
    }
    ```

    Update `src/lib/meal-plan/index.ts` barrel to also export from `./generate`.

    **Test cases:**

    Create a helper `makeRecipe(id, macros)` that returns a ScoredRecipe with given perServing macros:
    ```typescript
    function makeRecipe(id: string, macros: { calories: number; protein: number; carbs: number; fat: number }): ScoredRecipe {
      return { id, title: `Recipe ${id}`, perServing: macros, confidence: "high", cuisine: null, category: null };
    }
    ```

    Create a simple seeded PRNG for deterministic tests:
    ```typescript
    function seededRandom(seed: number): () => number {
      let s = seed;
      return () => { s = (s * 1103515245 + 12345) & 0x7fffffff; return s / 0x7fffffff; };
    }
    ```

    Test cases:
    - **Generates 14 slots** with a pool of 20+ recipes
    - **All 14 recipes are unique** (no duplicates in slots)
    - **Slot assignment is correct**: dayIndex 0-6 each appears exactly twice, mealType alternates midi/soir per day
    - **Deterministic with seeded random**: same seed + same pool = same result
    - **Different seeds produce different plans**
    - **Score is computed and reasonable**: overall > 0 for reasonable inputs
    - **Perfect match scenario**: 14 recipes each with (weeklyTarget / 14) macros -> score should be near 100
    - **Empty pool returns empty plan** with warning
    - **Pool of exactly 14** still works (no room for optimization but no crash)
    - **Small pool (< 14)** generates partial plan with warning
    - **Pool < 30** produces a warning about limited variety
    - **Low confidence filtering**: pool of 20 recipes where 10 are "low" confidence -> filtered pool used
    - **Local optimization improves score**: create a pool where one recipe is clearly better than another for the targets, verify optimization swaps it in
  </behavior>
  <implementation>
    Follow TDD red-green-refactor:
    1. RED: Write all tests in generate.test.ts. Tests import from generate.ts (will fail -- file doesn't exist). Run `pnpm test src/lib/meal-plan/__tests__/generate` -- all tests MUST fail.
    2. GREEN: Implement generate.ts. Run tests -- all MUST pass.
    3. REFACTOR: Clean up. Tests still pass.

    Important:
    - Accept `random` function parameter (default: Math.random) in GenerationParams for test determinism
    - All functions are pure (no DB, no React imports)
    - Keep local optimization simple: single-swap per slot, not multi-swap
    - The algorithm does NOT need to be globally optimal -- "good enough" with a high match score is the goal
    - Log-level debugging (console.debug) can be added but should not be in tests
  </implementation>
</feature>

<verification>
- `pnpm test src/lib/meal-plan` passes all tests (both score.test.ts and generate.test.ts)
- `pnpm check` passes
- No imports from React, Next.js, or DB modules in generate.ts
- Algorithm runs in <100ms for 200 recipes (not tested in unit tests, but verified by reasoning about the loop count)
</verification>

<success_criteria>
- generateMealPlan produces a PlanResult with 14 slots for a pool of 20+ recipes
- All 14 recipes in the plan are unique (no duplicates)
- Seeded random makes output deterministic
- Warnings produced for small pools (< 14, < 30)
- Empty pool handled gracefully
- Local optimization phase demonstrably improves score vs pure random
- At least 12 test cases covering normal, edge, and determinism scenarios
</success_criteria>

<output>
After completion, create `.planning/phases/06-basic-meal-plan-generation/06-03-SUMMARY.md`
</output>
