---
phase: 03-recipe-catalogue
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/app/recipes/[id]/page.tsx
  - src/app/recipes/[id]/loading.tsx
  - src/app/recipes/[id]/not-found.tsx
autonomous: false

must_haves:
  truths:
    - "User sees recipe title, image, description, prep time, cook time, total time, difficulty, and servings"
    - "User sees ingredient list with quantities, units, and names"
    - "User sees macro nutrients per serving (calories, protein, carbs, fat)"
    - "User sees tag badges for the recipe"
    - "User can click a link that opens the original Jow recipe in a new tab"
    - "Navigating to a non-existent recipe ID shows a proper not-found page"
  artifacts:
    - path: "src/app/recipes/[id]/page.tsx"
      provides: "Recipe detail Server Component with all recipe data"
      min_lines: 50
    - path: "src/app/recipes/[id]/loading.tsx"
      provides: "Skeleton loading state for detail page"
    - path: "src/app/recipes/[id]/not-found.tsx"
      provides: "Custom 404 for missing recipes"
  key_links:
    - from: "src/app/recipes/[id]/page.tsx"
      to: "src/db/queries/recipes.ts"
      via: "getRecipeById call"
      pattern: "getRecipeById\\("
    - from: "src/app/recipes/[id]/page.tsx"
      to: "next/navigation"
      via: "notFound() call for missing recipes"
      pattern: "notFound\\(\\)"
    - from: "src/app/recipes/[id]/page.tsx"
      to: "jowUrl"
      via: "external link with target=_blank"
      pattern: "target.*_blank|rel.*noopener"
    - from: "src/app/recipes/[id]/page.tsx"
      to: "jowNutritionPerServing JSONB"
      via: "typed cast and direct field access"
      pattern: "NutritionPerServing|calories|protein|carbs|fat|fiber"
---

<objective>
Build the recipe detail page at /recipes/[id] showing full recipe information: image, description, ingredients with quantities, macros per serving, prep/cook time, difficulty, tags, and a link to the original Jow recipe.

Purpose: Enables CAT-04 (view recipe details with macros) and CAT-05 (link to Jow original). This is the destination when users click a recipe card in the catalogue.
Output: Complete recipe detail page with loading skeleton and not-found handling.
</objective>

<execution_context>
@/Users/jimmydore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jimmydore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-recipe-catalogue/03-RESEARCH.md
@.planning/phases/03-recipe-catalogue/03-01-SUMMARY.md
@src/db/schema/recipes.ts
@src/db/schema/ingredients.ts
@src/db/schema/tags.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create recipe detail page with ingredients, macros, and Jow link</name>
  <files>
    src/app/recipes/[id]/page.tsx
    src/app/recipes/[id]/loading.tsx
    src/app/recipes/[id]/not-found.tsx
  </files>
  <action>
    1. Create src/app/recipes/[id]/page.tsx (Server Component):

       - CRITICAL: `params` is a Promise in Next.js 16. Must `await params`.
       - Type: `params: Promise<{ id: string }>`
       - Call `getRecipeById(id)` from src/db/queries/recipes.ts
       - If recipe is undefined, call `notFound()` from next/navigation
       - Generate dynamic metadata with `generateMetadata` function returning recipe.title

       Layout (use shadcn Separator for section dividers):

       **Header section:**
       - Back link: "Retour aux recettes" with left arrow icon (Lucide ArrowLeft), links to /recipes
       - Recipe title as h1 (text-3xl font-bold)
       - Tag badges row (shadcn Badge variant="secondary" for each tag)

       **Image + Meta section (responsive: side-by-side on lg, stacked on mobile):**
       - Left: Next.js Image (recipe.imageUrl, 500x500, rounded-lg, object-cover). If no imageUrl, show gray placeholder div.
       - Right: Meta info card with:
         - Prep time: `prepTimeMin` min (icon: Lucide Timer)
         - Cook time: `cookTimeMin` min (icon: Lucide Flame)
         - Total time: `totalTimeMin` min (icon: Lucide Clock)
         - Difficulty: recipe.difficulty (icon: Lucide ChefHat)
         - Servings: recipe.originalPortions portions (icon: Lucide Users)
         - Only show each field if value is non-null

       **Macros per serving section:**
       - Title: "Macros par portion"
       - The `jowNutritionPerServing` JSONB column has this exact structure (confirmed from database):
         ```typescript
         interface NutritionPerServing {
           fat: number;      // grams of fat per serving
           carbs: number;    // grams of carbs per serving
           fiber: number;    // grams of fiber per serving
           protein: number;  // grams of protein per serving
           calories: number; // kcal per serving
         }
         ```
       - Define this interface in the page file (or in a shared types file).
       - Cast `recipe.jowNutritionPerServing as NutritionPerServing | null`.
       - If non-null, render MacroBadge components in a flex row with gap:
         - `<MacroBadge label="Cal" value={nutrition.calories} unit="kcal" color="green" />`
         - `<MacroBadge label="P" value={nutrition.protein} unit="g" color="red" />`
         - `<MacroBadge label="G" value={nutrition.carbs} unit="g" color="blue" />`
         - `<MacroBadge label="L" value={nutrition.fat} unit="g" color="yellow" />`
         - Optionally also show fiber: `<MacroBadge label="Fibres" value={nutrition.fiber} unit="g" color="green" />` (use a lighter green variant or omit if design gets cluttered)
       - If jowNutritionPerServing is null, show "Macros non disponibles" in muted text

       **Ingredients section:**
       - Title: "Ingredients" (with count: e.g. "Ingredients (8)")
       - List each ingredient from recipeIngredients relation:
         - Format: "{quantity} {unit} {ingredient.name}" (e.g. "200 g Poulet")
         - If quantity is null, just show ingredient name
         - Show ingredient macros per 100g in small muted text below each ingredient: "P: Xg | G: Xg | L: Xg | Cal: X kcal" (only if macros are available on the ingredient)

       **Description section (if recipe.description exists):**
       - Title: "Description"
       - Render recipe.description as paragraph text

       **Jow link section:**
       - Button/link: "Voir sur Jow" with external link icon (Lucide ExternalLink)
       - Uses `<a href={recipe.jowUrl} target="_blank" rel="noopener noreferrer">`
       - Style as shadcn Button variant="outline"

    2. Create src/app/recipes/[id]/loading.tsx:
       - Skeleton layout matching the detail page structure
       - Large image skeleton, title skeleton, meta info skeletons, ingredient list skeletons

    3. Create src/app/recipes/[id]/not-found.tsx:
       - Simple page: "Recette introuvable" heading
       - "Cette recette n'existe pas ou a ete supprimee."
       - Link back to /recipes: "Retour au catalogue"
  </action>
  <verify>
    - `pnpm tsc --noEmit` passes
    - `pnpm check` (Biome) passes
    - `pnpm dev` starts without errors
    - Navigate to /recipes/[valid-id] -- shows full recipe detail
    - Navigate to /recipes/nonexistent-uuid -- shows not-found page
    - Recipe image loads from static.jow.fr
    - Ingredients list shows with quantities and ingredient macros
    - Macros per serving section shows numeric values for calories, protein, carbs, fat (not "Macros non disponibles") for recipes that have nutrition data
    - Jow link opens in new tab
    - Back link navigates to /recipes
  </verify>
  <done>
    Recipe detail page renders all recipe data: image, title, tags, time/difficulty/servings, macros per serving (parsed from JSONB as { calories, protein, carbs, fat, fiber }), ingredients with quantities and per-100g macros, description, and Jow external link. Not-found page handles missing recipes. Loading skeleton shows during data fetch.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Recipe detail page at /recipes/[id] with full recipe information, macros, ingredients, and Jow link.</what-built>
  <how-to-verify>
    Prerequisites: Have recipes in local DB. Get a recipe ID from the catalogue page (click a card).

    1. Click a recipe card from /recipes -- should navigate to /recipes/[id]
    2. Verify: recipe image displays (large, rounded corners)
    3. Verify: title, tags shown correctly
    4. Verify: prep time, cook time, total time, difficulty, servings displayed (where available)
    5. Verify: macros per serving section shows calories, protein, carbs, fat values as colored badges (not "Macros non disponibles")
    6. Verify: ingredients list shows quantity, unit, ingredient name for each ingredient
    7. Verify: ingredient macros (per 100g) shown in muted text below each ingredient
    8. Verify: "Voir sur Jow" button exists and opens the Jow recipe URL in a new browser tab
    9. Verify: "Retour aux recettes" link navigates back to /recipes
    10. Navigate to /recipes/00000000-0000-0000-0000-000000000000 -- should show not-found page
    11. Resize browser -- layout should be responsive (image stacks on mobile)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `pnpm tsc --noEmit` -- no type errors
2. `pnpm check` -- Biome passes
3. /recipes/[valid-id] shows complete recipe detail with image, macros, ingredients, Jow link
4. /recipes/[invalid-id] shows not-found page
5. Macros per serving shows actual numeric values from jowNutritionPerServing JSONB
6. Back link returns to catalogue
7. Jow link opens in new tab
8. Responsive layout works on mobile and desktop
</verification>

<success_criteria>
- Recipe detail page shows image, title, description, tags, prep/cook/total time, difficulty, servings
- Macros per serving displayed (calories, protein, carbs, fat) using MacroBadge, parsed from JSONB { fat, carbs, fiber, protein, calories }
- Ingredients listed with quantities, units, names, and per-100g macros
- "Voir sur Jow" link opens original Jow recipe in new tab (target="_blank")
- Not-found page renders for invalid recipe IDs
- Loading skeleton appears during data fetch
- Back link navigates to /recipes catalogue
- Responsive layout (side-by-side on desktop, stacked on mobile)
- All code compiles and passes lint
</success_criteria>

<output>
After completion, create `.planning/phases/03-recipe-catalogue/03-03-SUMMARY.md`
</output>
