---
phase: 01-project-foundation-database-deployment
plan: 05
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - docker-compose.prod.yml
  - deploy/nginx/mealprep.conf
  - deploy/setup-vps.sh
autonomous: false

user_setup:
  - service: vps
    why: "Production deployment target"
    env_vars:
      - name: VPS_HOST
        source: "Your VPS IP address or hostname"
      - name: VPS_USER
        source: "SSH user on VPS (e.g., deploy or root)"
      - name: VPS_SSH_KEY
        source: "Ed25519 private key for SSH access (ssh-keygen -t ed25519)"
    dashboard_config:
      - task: "Create DNS A record for subdomain pointing to VPS IP"
        location: "Domain registrar DNS management"
      - task: "Clone repo on VPS and create .env.production"
        location: "SSH into VPS"
      - task: "Add Nginx config and run Certbot for SSL"
        location: "SSH into VPS"

must_haves:
  truths:
    - "docker-compose.prod.yml builds and starts the app + Postgres in production mode"
    - "Nginx config file is ready to proxy to localhost:3000"
    - "VPS setup script documents all steps for user to configure the server"
  artifacts:
    - path: "docker-compose.prod.yml"
      provides: "Production Docker Compose with app + Postgres"
      contains: "127.0.0.1:3000:3000"
    - path: "deploy/nginx/mealprep.conf"
      provides: "Nginx reverse proxy config for the app"
      contains: "proxy_pass"
    - path: "deploy/setup-vps.sh"
      provides: "VPS setup instructions as executable script"
      contains: "certbot"
  key_links:
    - from: "docker-compose.prod.yml"
      to: "Dockerfile"
      via: "build context"
      pattern: "build:"
    - from: "deploy/nginx/mealprep.conf"
      to: "docker-compose.prod.yml"
      via: "proxy to app port"
      pattern: "127.0.0.1:3000"
---

<objective>
Create production Docker Compose configuration, Nginx reverse proxy config, and VPS setup script. The user will apply these configs on their VPS.

Purpose: This prepares all production infrastructure artifacts. The VPS deployment is collaborative -- Claude creates the configs, the user applies them on the server. This unlocks auto-deploy in Plan 06.
Output: docker-compose.prod.yml, Nginx config file, VPS setup script with step-by-step instructions.
</objective>

<execution_context>
@/Users/jimmydore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jimmydore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-project-foundation-database-deployment/01-RESEARCH.md
@.planning/phases/01-project-foundation-database-deployment/01-CONTEXT.md

# Need Dockerfile from Plan 01
@.planning/phases/01-project-foundation-database-deployment/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create production Docker Compose and Nginx config</name>
  <files>
    docker-compose.prod.yml
    deploy/nginx/mealprep.conf
  </files>
  <action>
    1. Create `docker-compose.prod.yml` for production:
    - `db` service: postgres:16-alpine, restart unless-stopped, env vars from ${POSTGRES_DB}, ${POSTGRES_USER}, ${POSTGRES_PASSWORD}, named volume pgdata_prod, healthcheck, internal network only (no exposed ports)
    - `app` service: build from Dockerfile, restart unless-stopped, ports "127.0.0.1:3000:3000" (localhost only -- Nginx proxies), env DATABASE_URL using internal Docker network hostname (db:5432), NODE_ENV=production, depends_on db healthy, internal network
    - Networks: single bridge network named "internal"
    - Volumes: pgdata_prod
    - NO Nginx service (Nginx runs on VPS host, not in Docker)
    (See exact pattern in RESEARCH.md "Docker Compose for Production")

    2. Create `deploy/nginx/mealprep.conf`:
    - Server block listening on port 80
    - server_name using placeholder: `mealprep.example.com` (user replaces with actual subdomain)
    - location / with proxy_pass to http://127.0.0.1:3000
    - Include WebSocket headers: Upgrade, Connection, Host, X-Real-IP, X-Forwarded-For, X-Forwarded-Proto
    - proxy_cache_bypass $http_upgrade
    - Comment at top: "# Replace mealprep.example.com with your actual domain"
    - Comment at bottom: "# After placing in /etc/nginx/sites-available/, run: sudo certbot --nginx -d mealprep.example.com"
    (See exact pattern in RESEARCH.md "Nginx Server Block for VPS")
  </action>
  <verify>
    - `docker compose -f docker-compose.prod.yml config` validates the compose file without errors
    - `deploy/nginx/mealprep.conf` exists and contains proxy_pass to 127.0.0.1:3000
    - Production compose does NOT expose Postgres ports to host
    - Production compose binds app to 127.0.0.1 only
  </verify>
  <done>Production Docker Compose ready with app + Postgres on internal network. Nginx config ready for reverse proxy with SSL via Certbot.</done>
</task>

<task type="auto">
  <name>Task 2: Create VPS setup script with step-by-step instructions</name>
  <files>
    deploy/setup-vps.sh
  </files>
  <action>
    1. Create `deploy/setup-vps.sh` -- an executable bash script that documents and performs VPS setup:

    ```bash
    #!/bin/bash
    # VPS Setup Script for Meal Prep
    # Run this on your VPS as root or with sudo
    #
    # Prerequisites:
    # - Ubuntu/Debian VPS with Docker and Docker Compose installed
    # - Nginx and Certbot already installed and running
    # - Git installed
    # - A DNS A record pointing your subdomain to the VPS IP
    #
    # Usage: Replace DOMAIN, DEPLOY_USER, and REPO_URL variables, then run.

    set -euo pipefail

    # ====== CONFIGURE THESE ======
    DOMAIN="mealprep.example.com"    # Your subdomain
    DEPLOY_USER="deploy"              # SSH user for deployments
    REPO_URL="git@github.com:USER/meal-prep.git"  # Your repo URL
    APP_DIR="/opt/mealprep"           # Where the app lives on VPS
    # =============================

    echo "=== Step 1: Create deploy user (if not exists) ==="
    if ! id "$DEPLOY_USER" &>/dev/null; then
      adduser --system --group --shell /bin/bash "$DEPLOY_USER"
      usermod -aG docker "$DEPLOY_USER"
      echo "Created user $DEPLOY_USER and added to docker group"
    fi

    echo "=== Step 2: Setup SSH key for deploy user ==="
    DEPLOY_HOME=$(eval echo ~$DEPLOY_USER)
    mkdir -p "$DEPLOY_HOME/.ssh"
    echo "Add your deploy public key to: $DEPLOY_HOME/.ssh/authorized_keys"
    echo "On your local machine, generate with: ssh-keygen -t ed25519 -C 'deploy-mealprep'"
    echo "Then add the PRIVATE key to GitHub Secrets as VPS_SSH_KEY"

    echo "=== Step 3: Clone repository ==="
    mkdir -p "$APP_DIR"
    chown "$DEPLOY_USER:$DEPLOY_USER" "$APP_DIR"
    if [ ! -d "$APP_DIR/.git" ]; then
      su - "$DEPLOY_USER" -c "git clone $REPO_URL $APP_DIR"
    fi

    echo "=== Step 4: Create production .env ==="
    if [ ! -f "$APP_DIR/.env" ]; then
      cat > "$APP_DIR/.env" << 'ENVEOF'
    POSTGRES_DB=mealprep
    POSTGRES_USER=mealprep
    POSTGRES_PASSWORD=CHANGE_ME_TO_A_STRONG_PASSWORD
    DATABASE_URL=postgresql://mealprep:CHANGE_ME_TO_A_STRONG_PASSWORD@db:5432/mealprep
    NODE_ENV=production
    ENVEOF
      chown "$DEPLOY_USER:$DEPLOY_USER" "$APP_DIR/.env"
      echo "IMPORTANT: Edit $APP_DIR/.env and set a strong POSTGRES_PASSWORD"
      echo "Make sure DATABASE_URL password matches POSTGRES_PASSWORD"
    fi

    echo "=== Step 5: Setup Nginx ==="
    cp "$APP_DIR/deploy/nginx/mealprep.conf" /etc/nginx/sites-available/mealprep
    sed -i "s/mealprep.example.com/$DOMAIN/g" /etc/nginx/sites-available/mealprep
    ln -sf /etc/nginx/sites-available/mealprep /etc/nginx/sites-enabled/
    nginx -t && systemctl reload nginx
    echo "Nginx configured for $DOMAIN"

    echo "=== Step 6: SSL Certificate ==="
    certbot --nginx -d "$DOMAIN"
    echo "SSL certificate installed for $DOMAIN"

    echo "=== Step 7: Initial deployment ==="
    cd "$APP_DIR"
    su - "$DEPLOY_USER" -c "cd $APP_DIR && docker compose -f docker-compose.prod.yml build"
    su - "$DEPLOY_USER" -c "cd $APP_DIR && docker compose -f docker-compose.prod.yml up -d"
    echo "App is running at https://$DOMAIN"

    echo ""
    echo "=== Setup Complete ==="
    echo "Next steps:"
    echo "1. Edit $APP_DIR/.env with a strong password"
    echo "2. Add GitHub Secrets: VPS_HOST, VPS_USER ($DEPLOY_USER), VPS_SSH_KEY"
    echo "3. Push to main to trigger auto-deploy"
    ```

    Make the script executable in the file header comment (chmod +x).

    IMPORTANT: This script is a GUIDE. The user reads it, adjusts variables, and runs it. It's not meant to be blindly executed. Include clear comments explaining each step.
  </action>
  <verify>
    - `deploy/setup-vps.sh` exists and is well-commented
    - Script covers: deploy user, SSH key, repo clone, .env creation, Nginx config, Certbot SSL, initial Docker build
    - All placeholder values are clearly marked for user to replace
  </verify>
  <done>VPS setup script created with 7-step setup process. User can follow the script to configure their VPS: deploy user, SSH keys, repo clone, production .env, Nginx reverse proxy, SSL via Certbot, and initial Docker deployment.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Production Docker Compose, Nginx config, and VPS setup script. All files are ready for the user to configure their VPS.</what-built>
  <how-to-verify>
    1. Review `docker-compose.prod.yml` -- confirm it matches your VPS expectations
    2. Review `deploy/nginx/mealprep.conf` -- confirm it will coexist with your existing Nginx sites
    3. Review `deploy/setup-vps.sh` -- update variables (DOMAIN, DEPLOY_USER, REPO_URL)
    4. Run the setup script on your VPS (or follow steps manually)
    5. Confirm the app is accessible at https://your-domain (may show Next.js default page or error -- that's OK, full deployment comes in Plan 06)
    6. Report back: VPS hostname, deploy user, and confirm GitHub Secrets are set (VPS_HOST, VPS_USER, VPS_SSH_KEY)
  </how-to-verify>
  <resume-signal>Type "VPS configured" with your domain name, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
1. `docker compose -f docker-compose.prod.yml config` validates without errors
2. Nginx config proxies to 127.0.0.1:3000 with WebSocket headers
3. VPS setup script covers all deployment prerequisites
4. User confirms VPS is accessible and GitHub Secrets are set
</verification>

<success_criteria>
- Production Docker Compose builds and runs app + Postgres
- Nginx config ready for reverse proxy with SSL
- VPS setup script provides clear step-by-step instructions
- User has configured VPS and confirmed accessibility
- GitHub Secrets (VPS_HOST, VPS_USER, VPS_SSH_KEY) are set
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-foundation-database-deployment/01-05-SUMMARY.md`
</output>
