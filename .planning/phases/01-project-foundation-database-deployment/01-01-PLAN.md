---
phase: 01-project-foundation-database-deployment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - pnpm-lock.yaml
  - tsconfig.json
  - next.config.ts
  - src/app/layout.tsx
  - src/app/page.tsx
  - src/app/globals.css
  - src/lib/env.ts
  - src/lib/utils.ts
  - src/db/index.ts
  - drizzle.config.ts
  - docker-compose.yml
  - Dockerfile
  - .env
  - .env.example
  - .gitignore
  - biome.json
  - components.json
autonomous: true

must_haves:
  truths:
    - "pnpm dev starts the Next.js dev server without errors"
    - "docker compose up starts Postgres dev + test databases"
    - "Drizzle client connects to Postgres and executes a raw query"
    - "Biome lint and format run without configuration errors"
  artifacts:
    - path: "package.json"
      provides: "Project definition with all Phase 1 dependencies"
      contains: "drizzle-orm"
    - path: "src/db/index.ts"
      provides: "Drizzle client singleton with snake_case casing"
      contains: "casing"
    - path: "drizzle.config.ts"
      provides: "Drizzle Kit config with snake_case casing"
      contains: "casing"
    - path: "src/lib/env.ts"
      provides: "Type-safe env validation with Zod"
      contains: "DATABASE_URL"
    - path: "docker-compose.yml"
      provides: "Dev environment with Postgres on 5433 and test DB on 5434"
      contains: "5433:5432"
    - path: "Dockerfile"
      provides: "Multi-stage Next.js standalone build"
      contains: "standalone"
    - path: "biome.json"
      provides: "Biome linter/formatter config"
      contains: "biomejs.dev"
  key_links:
    - from: "src/db/index.ts"
      to: "src/lib/env.ts"
      via: "DATABASE_URL import"
      pattern: "env\\.DATABASE_URL"
    - from: "drizzle.config.ts"
      to: ".env"
      via: "dotenv/config import"
      pattern: "dotenv/config"
---

<objective>
Scaffold the Next.js project with all Phase 1 dependencies, configure Drizzle ORM client, Docker Compose for dev databases, multi-stage Dockerfile, Biome linting, and type-safe environment variables.

Purpose: This is the foundation everything else builds on. No other plan can execute without the project scaffolding, package dependencies, Docker databases, and Drizzle client in place.
Output: A working Next.js project that starts in dev mode, connects to Postgres via Docker Compose, and passes Biome lint checks.
</objective>

<execution_context>
@/Users/jimmydore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jimmydore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-project-foundation-database-deployment/01-RESEARCH.md
@.planning/phases/01-project-foundation-database-deployment/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold Next.js project with all dependencies</name>
  <files>
    package.json
    pnpm-lock.yaml
    tsconfig.json
    next.config.ts
    src/app/layout.tsx
    src/app/page.tsx
    src/app/globals.css
    .gitignore
  </files>
  <action>
    1. Run `pnpm create next-app@latest . --typescript --tailwind --app --src-dir --use-pnpm` in the project root. Accept defaults for any prompts (the repo already has a .git, so scaffolding into existing dir).

    2. Install all Phase 1 dependencies:
    ```
    pnpm add drizzle-orm postgres zod@3 dotenv @t3-oss/env-nextjs
    pnpm add -D drizzle-kit vitest @vitejs/plugin-react @testing-library/react @testing-library/dom vite-tsconfig-paths jsdom
    pnpm add -D -E @biomejs/biome
    ```

    3. Run `pnpm dlx shadcn@latest init` to initialize shadcn/ui. Choose defaults: New York style, Zinc color, CSS variables yes.

    4. Update `next.config.ts` (or `.mjs` -- use whatever the scaffolding generated):
    - Add `output: "standalone"` for Docker production builds
    - Keep all other defaults

    5. Remove any ESLint configuration that Next.js scaffolding created (`eslint.config.mjs`, `.eslintrc*`, etc.) -- Biome replaces it entirely. Also remove `eslint`, `eslint-config-next` from dependencies if present and remove the `lint` script or replace it with biome.

    6. Update package.json scripts:
    ```json
    "scripts": {
      "dev": "next dev",
      "build": "next build",
      "start": "next start",
      "lint": "biome ci .",
      "format": "biome format --write .",
      "check": "biome check --write .",
      "test": "vitest",
      "db:generate": "drizzle-kit generate",
      "db:migrate": "drizzle-kit migrate",
      "db:push": "drizzle-kit push",
      "db:studio": "drizzle-kit studio",
      "db:seed": "tsx src/db/seed.ts"
    }
    ```

    7. Ensure `.gitignore` includes: `.env`, `.env.local`, `node_modules/`, `.next/`, `drizzle/meta/` (but NOT `drizzle/*.sql` -- migration files must be committed).

    IMPORTANT: Use the exact library versions from RESEARCH.md. Install zod@3 explicitly (NOT v4). Use pnpm throughout (NOT npm or yarn).
  </action>
  <verify>
    - `pnpm dev` starts without errors (Ctrl+C after confirming)
    - `pnpm biome ci .` runs without config errors (may have lint warnings on generated code -- that's OK)
    - `cat package.json | grep drizzle-orm` confirms drizzle is installed
    - `cat package.json | grep vitest` confirms vitest is installed
    - `ls src/components/ui/` confirms shadcn/ui initialized (should have at least utils)
  </verify>
  <done>Next.js project scaffolded with all Phase 1 dependencies installed, ESLint removed, Biome configured, shadcn/ui initialized, and package.json scripts set up.</done>
</task>

<task type="auto">
  <name>Task 2: Configure Drizzle client, env validation, Docker Compose dev, Dockerfile, and Biome</name>
  <files>
    src/lib/env.ts
    src/db/index.ts
    drizzle.config.ts
    docker-compose.yml
    Dockerfile
    .env
    .env.example
    biome.json
  </files>
  <action>
    1. Create `src/lib/env.ts` using @t3-oss/env-nextjs with Zod validation:
    - Server vars: DATABASE_URL (z.string().url()), NODE_ENV (z.enum with default "development")
    - Client vars: empty for now
    - runtimeEnv mapping both vars
    (See exact code in RESEARCH.md "Environment Variable Configuration" section)

    2. Create `src/db/index.ts` -- Drizzle client singleton:
    - Import postgres from "postgres" and drizzle from "drizzle-orm/postgres-js"
    - Import env from "@/lib/env"
    - Create postgres client with env.DATABASE_URL
    - Export db = drizzle(client, { casing: "snake_case" })
    - CRITICAL: Include `casing: "snake_case"` -- this auto-maps camelCase TS to snake_case Postgres
    - For dev HMR safety, use globalThis singleton pattern:
      ```typescript
      const globalForDb = globalThis as unknown as { db: typeof db };
      export const db = globalForDb.db || drizzle(client, { casing: "snake_case" });
      if (process.env.NODE_ENV !== "production") globalForDb.db = db;
      ```
    - NOTE: Do NOT import schema yet (schema files created in Plan 02). Just initialize the client without schema parameter for now.

    3. Create `drizzle.config.ts`:
    - Import "dotenv/config" at top
    - dialect: "postgresql"
    - schema: "./src/db/schema"
    - out: "./drizzle"
    - casing: "snake_case"
    - dbCredentials.url from process.env.DATABASE_URL!
    (See exact code in RESEARCH.md "Pattern 2")

    4. Create `docker-compose.yml` for development with TWO Postgres services:
    - `db`: Postgres 16-alpine, port 5433:5432, named volume pgdata_dev, POSTGRES_DB=mealprep, POSTGRES_USER=mealprep, POSTGRES_PASSWORD=mealprep_dev, healthcheck
    - `db-test`: Postgres 16-alpine, port 5434:5432, tmpfs for RAM speed, POSTGRES_DB=mealprep_test, POSTGRES_USER=mealprep_test, POSTGRES_PASSWORD=mealprep_test, healthcheck
    - NO app service in dev compose -- Next.js runs locally with `pnpm dev` for faster HMR
    - volumes section declaring pgdata_dev
    (See exact code in RESEARCH.md "Docker Compose for Development" but REMOVE the app service)

    5. Create `Dockerfile` -- 3-stage multi-stage build:
    - Stage 1 (base): node:22-alpine
    - Stage 2 (builder): corepack enable, pnpm install --frozen-lockfile, copy source, pnpm build
    - Stage 3 (runner): production env, copy public + .next/standalone + .next/static, run as non-root user
    - EXPOSE 3000, CMD ["node", "server.js"]
    (See exact code in RESEARCH.md "Pattern 5")

    6. Create `.env` with dev values:
    ```
    DATABASE_URL=postgresql://mealprep:mealprep_dev@localhost:5433/mealprep
    NODE_ENV=development
    ```

    7. Create `.env.example` (same structure, placeholder values):
    ```
    DATABASE_URL=postgresql://user:password@localhost:5433/dbname
    NODE_ENV=development
    ```

    8. Create `biome.json`:
    - Use the exact config from RESEARCH.md "Biome Configuration" section
    - $schema pointing to v2 schema
    - VCS enabled with git, useIgnoreFile true
    - Include src/**/*.ts, src/**/*.tsx, *.config.ts, *.config.mts
    - Formatter: space indent, 2 width, 100 line width
    - Linter: recommended rules
    - JS formatter: double quotes, semicolons always
  </action>
  <verify>
    - `docker compose up -d db db-test` starts both Postgres instances
    - `docker compose ps` shows both db services healthy
    - `psql postgresql://mealprep:mealprep_dev@localhost:5433/mealprep -c "SELECT 1"` returns 1 (or use `docker compose exec db psql -U mealprep -d mealprep -c "SELECT 1"`)
    - `pnpm biome ci .` runs with Biome v2 config
    - `pnpm dev` starts and the Next.js page loads at http://localhost:3000
  </verify>
  <done>Drizzle client configured with snake_case casing, env validation working, Docker Compose starts 2 Postgres instances (dev on 5433, test on 5434), Dockerfile ready for production builds, Biome configured and running.</done>
</task>

</tasks>

<verification>
1. `docker compose up -d` starts Postgres dev + test databases without errors
2. `pnpm dev` starts Next.js dev server, page loads at http://localhost:3000
3. `pnpm biome ci .` runs linting/formatting checks
4. `.env` contains valid DATABASE_URL pointing to Docker Postgres
5. `drizzle.config.ts` has both `casing: "snake_case"` and `dialect: "postgresql"`
6. `src/db/index.ts` has `casing: "snake_case"` in drizzle() call
7. `Dockerfile` has 3 stages and copies standalone + static + public
</verification>

<success_criteria>
- Project scaffolded and all dependencies installed via pnpm
- Docker Compose starts dev and test Postgres databases
- Drizzle client connects to Postgres (verified by pnpm dev not crashing)
- Biome replaces ESLint, lint command works
- Dockerfile builds successfully (verified in Plan 05)
- Environment variables validated via @t3-oss/env-nextjs
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-foundation-database-deployment/01-01-SUMMARY.md`
</output>
