---
phase: 04-authentication-user-profile
plan: 04
type: execute
wave: 3
depends_on: ["04-02", "04-03"]
files_modified:
  - src/app/(authenticated)/onboarding/page.tsx
  - src/components/onboarding/wizard.tsx
  - src/components/onboarding/step-physical.tsx
  - src/components/onboarding/step-goal.tsx
  - src/components/onboarding/step-dietary.tsx
  - src/components/onboarding/step-sport.tsx
  - src/components/onboarding/progress-indicator.tsx
  - src/app/(authenticated)/settings/profile/page.tsx
  - src/app/(authenticated)/layout.tsx
  - src/app/actions/profile.ts
autonomous: false

must_haves:
  truths:
    - "New user is redirected to /onboarding on first login"
    - "User can fill physical info (weight, height, age, sex, activity level) in step 1"
    - "User can select nutritional goal and household size in step 2"
    - "User can select dietary preferences from curated list in step 3"
    - "User can add sport activities with type and frequency in step 4"
    - "Submitting the wizard saves all data to the database"
    - "User can edit their profile later at /settings/profile"
    - "Profile data is pre-populated when editing"
  artifacts:
    - path: "src/components/onboarding/wizard.tsx"
      provides: "Multi-step wizard container with navigation"
      min_lines: 50
    - path: "src/components/onboarding/step-physical.tsx"
      provides: "Physical info form fields"
      contains: "weight"
    - path: "src/components/onboarding/step-goal.tsx"
      provides: "Goal selection cards + household size"
      contains: "goal"
    - path: "src/components/onboarding/step-dietary.tsx"
      provides: "Dietary preference checkboxes"
      contains: "dietaryPreferences"
    - path: "src/components/onboarding/step-sport.tsx"
      provides: "Sport activity list with add/remove"
      contains: "sportActivities"
    - path: "src/app/actions/profile.ts"
      provides: "Server action to save profile data"
      contains: "upsertUserProfile"
    - path: "src/app/(authenticated)/onboarding/page.tsx"
      provides: "Onboarding page hosting the wizard"
      min_lines: 10
    - path: "src/app/(authenticated)/settings/profile/page.tsx"
      provides: "Settings page reusing wizard for editing"
      min_lines: 10
  key_links:
    - from: "src/components/onboarding/wizard.tsx"
      to: "src/app/actions/profile.ts"
      via: "form submission"
      pattern: "saveProfile"
    - from: "src/app/actions/profile.ts"
      to: "src/db/queries/profiles.ts"
      via: "upsertUserProfile + setUserDietaryPreferences + setUserSportActivities"
      pattern: "upsertUserProfile"
    - from: "src/app/(authenticated)/layout.tsx"
      to: "src/db/queries/profiles.ts"
      via: "isProfileComplete check"
      pattern: "isProfileComplete"
---

<objective>
Build the onboarding wizard (4 steps) and settings page for editing profile data.

Purpose: Users configure all data needed for macro calculation and meal plan generation. Covers PROF-04, PROF-05, PROF-06, PROF-07.
Output: Working onboarding wizard, settings page, and server action that persists profile data.
</objective>

<execution_context>
@/Users/jimmydore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jimmydore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-authentication-user-profile/04-RESEARCH.md
@.planning/phases/04-authentication-user-profile/04-CONTEXT.md
@.planning/phases/04-authentication-user-profile/04-02-SUMMARY.md
@.planning/phases/04-authentication-user-profile/04-03-SUMMARY.md
@src/lib/schemas/profile.ts
@src/db/queries/profiles.ts
@src/lib/auth.ts
@src/lib/auth-client.ts
@src/app/(authenticated)/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Onboarding wizard components + server action</name>
  <files>
    src/components/onboarding/wizard.tsx
    src/components/onboarding/step-physical.tsx
    src/components/onboarding/step-goal.tsx
    src/components/onboarding/step-dietary.tsx
    src/components/onboarding/step-sport.tsx
    src/components/onboarding/progress-indicator.tsx
    src/app/actions/profile.ts
  </files>
  <action>
**1. Create `src/components/onboarding/progress-indicator.tsx`:**
- Client component
- Props: `steps: string[]`, `currentStep: number`
- Horizontal step indicator (circles + lines)
- Current step highlighted, completed steps have checkmark
- Step labels: "Physique", "Objectif", "Alimentation", "Sport"

**2. Create `src/components/onboarding/step-physical.tsx`:**
- Client component, receives react-hook-form's `useFormContext`
- Fields (all French labels):
  - Poids (kg): number input, 30-300
  - Taille (cm): number input, 100-250
  - Age: number input, 14-100
  - Sexe: radio group "Homme" / "Femme"
  - Niveau d'activite: select with 5 options using activityLevelLabels from profile schema
- Uses shadcn Form, Input, RadioGroup, Select, Label

**3. Create `src/components/onboarding/step-goal.tsx`:**
- Client component
- Goal selection: 4 visual cards in a 2x2 grid
  - Seche: icon (TrendingDown or similar), "Perdre du gras tout en preservant le muscle"
  - Maintien: icon (Scale or similar), "Maintenir votre poids et composition actuelle"
  - Prise de masse: icon (TrendingUp or similar), "Gagner du muscle avec un surplus calorique"
  - Recomposition: icon (RefreshCw or similar), "Perdre du gras et gagner du muscle simultanement"
- Selected card has distinct border/background
- Household size: number input "Nombre de personnes" (1-6), default 1
- Uses shadcn Card, Input, Label

**4. Create `src/components/onboarding/step-dietary.tsx`:**
- Client component
- Checkbox list of 7 dietary preferences using dietaryPreferenceLabels
- Each checkbox shows the French label
- Multiple selections allowed
- No selection is valid (no dietary restrictions)
- Brief explanation text: "Selectionnez vos restrictions alimentaires. Ces preferences sont des exclusions strictes."

**5. Create `src/components/onboarding/step-sport.tsx`:**
- Client component
- Dynamic list of sport activities
- Each entry: Select (activity type from activityTypeLabels) + number input (frequency 1-7 per week) + remove button
- "Ajouter une activite" button to add new entry
- Empty state: "Aucune activite sportive ajoutee" with add button
- Prevent duplicate activity types (disable already-selected types in select)

**6. Create `src/components/onboarding/wizard.tsx`:**
- Client component ("use client")
- Uses react-hook-form `useForm` with `zodResolver(profileSchema)`
- Props: `defaultValues?: Partial<ProfileFormData>`, `mode: "onboarding" | "settings"`
- State: `currentStep` (0-3)
- FormProvider wraps all steps
- Step navigation:
  - "Suivant" button validates current step fields before advancing (use `form.trigger(fieldsForStep)`)
  - "Precedent" button goes back without validation
  - Final step shows "Terminer" button that submits
- Step 0: StepPhysical, validate [weight, height, age, sex, activityLevel]
- Step 1: StepGoal, validate [goal, householdSize]
- Step 2: StepDietary, validate [dietaryPreferences] (always valid — empty array OK)
- Step 3: StepSport, validate [sportActivities] (always valid — empty array OK)
- On submit: call `saveProfile` server action
- On success in onboarding mode: redirect to "/"
- On success in settings mode: show success toast (use sonner if available, or simple state message)
- Loading state on submit button

**7. Create `src/app/actions/profile.ts`:**
- "use server" server action
- `saveProfile(data: ProfileFormData)` function
- Gets session via `auth.api.getSession({ headers: await headers() })`
- If no session, throw error
- Calls in transaction:
  - `upsertUserProfile(userId, { weight, height, age, sex, activityLevel, goal, householdSize, mealsPerDay: 2 })`
  - `setUserDietaryPreferences(userId, data.dietaryPreferences)`
  - `setUserSportActivities(userId, data.sportActivities)`
- Returns `{ success: true }` or `{ error: string }`
  </action>
  <verify>
1. `pnpm build` succeeds
2. All wizard step components render without errors
3. Form validation works (try submitting step 1 with empty fields — should show errors)
  </verify>
  <done>4-step onboarding wizard with form validation, progress indicator, and server action that persists all profile data.</done>
</task>

<task type="auto">
  <name>Task 2: Onboarding page + settings page + onboarding redirect</name>
  <files>
    src/app/(authenticated)/onboarding/page.tsx
    src/app/(authenticated)/settings/profile/page.tsx
    src/app/(authenticated)/layout.tsx
  </files>
  <action>
**1. Create `src/app/(authenticated)/onboarding/page.tsx`:**
- Server component
- Gets session, then checks if profile is already complete via `isProfileComplete(userId)`
- If profile complete, redirect to "/" (don't show wizard again)
- Renders `<OnboardingWizard mode="onboarding" />`
- Page title: "Configurez votre profil"
- Centered layout, max-w-2xl

**2. Create `src/app/(authenticated)/settings/profile/page.tsx`:**
- Server component
- Gets session, loads existing profile via `getFullUserProfile(userId)`
- Passes profile data as `defaultValues` to the wizard
- Renders `<OnboardingWizard mode="settings" defaultValues={profileData} />`
- Page title: "Modifier votre profil"
- Centered layout, max-w-2xl

**3. Update `src/app/(authenticated)/layout.tsx`:**
- After session check, check if profile is complete via `isProfileComplete(session.user.id)`
- If NOT complete AND current path is NOT "/onboarding", redirect to "/onboarding"
- This ensures new users are funneled through onboarding before accessing any page
- Onboarding page itself is excluded from this check (avoid redirect loop)

To get the current path in a server layout, use the `headers()` function and read the `x-pathname` or `x-url` header (set by proxy.ts), OR use a different approach: Add the pathname check in the onboarding page itself (skip redirect if already on /onboarding). The simplest approach:

```typescript
// In layout.tsx
const pathname = (await headers()).get("x-next-pathname") || "";
const profileComplete = await isProfileComplete(session.user.id);
if (!profileComplete && !pathname.startsWith("/onboarding")) {
  redirect("/onboarding");
}
```

If the header approach doesn't work with Next.js 16, use an alternative: add a `searchParams` or cookie-based check instead. The key is: new users must go to /onboarding first.

**4. Add "Profil" link to the header component** (update src/components/header.tsx):
- Add a link to /settings/profile in the header navigation or user dropdown
- Label: "Mon profil"
  </action>
  <verify>
1. `pnpm build` succeeds
2. Register new account — after login, redirects to /onboarding
3. Complete wizard — redirects to / (then /recipes)
4. Subsequent logins go directly to /recipes (no onboarding)
5. Visit /settings/profile — wizard shows with pre-filled data
6. Update data in settings — saves successfully
  </verify>
  <done>New users redirected to onboarding wizard. Completed profiles go to recipes. Settings page lets users edit profile with pre-populated data. Header has "Mon profil" link.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete onboarding wizard (4 steps: physical info, goal, dietary preferences, sport schedule) and settings page. New users are automatically redirected to onboarding. Profile data persists and pre-populates on edit.</what-built>
  <how-to-verify>
1. Register a NEW account (different email from previous tests)
2. Should redirect to /onboarding after login
3. Step 1: Fill physical info (75kg, 180cm, 30 years, Homme, Actif) — click Suivant
4. Step 2: Select "Prise de masse" goal card, household size 2 — click Suivant
5. Step 3: Check "Sans porc" and "Sans gluten" — click Suivant
6. Step 4: Add "Course / Running" x3/week and "Musculation" x2/week — click Terminer
7. Should redirect to /recipes
8. Refresh — should stay on /recipes (not redirected to onboarding)
9. Click "Mon profil" in header — settings page shows all data pre-filled
10. Change weight to 80kg, click save — should confirm success
11. Refresh settings page — weight shows 80kg
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- New users redirected to /onboarding
- All 4 wizard steps validate and save correctly
- Profile data persists in database (check via DB query)
- Settings page pre-populates with saved data
- Profile edits save correctly
- Users with complete profiles skip onboarding
</verification>

<success_criteria>
PROF-04 (physical profile), PROF-05 (nutritional goal), PROF-06 (dietary preferences), PROF-07 (sport schedule) are fully working. New users complete onboarding before accessing the app. Existing users can edit via settings. All data isolated per user.
</success_criteria>

<output>
After completion, create `.planning/phases/04-authentication-user-profile/04-04-SUMMARY.md`
</output>
