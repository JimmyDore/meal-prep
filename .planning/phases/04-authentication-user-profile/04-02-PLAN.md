---
phase: 04-authentication-user-profile
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/app/auth/page.tsx
  - src/components/auth/login-form.tsx
  - src/components/auth/register-form.tsx
  - src/app/(authenticated)/layout.tsx
  - src/app/(authenticated)/recipes/page.tsx
  - src/app/(authenticated)/recipes/[id]/page.tsx
  - src/app/(authenticated)/recipes/[id]/not-found.tsx
  - src/app/(authenticated)/recipes/[id]/loading.tsx
  - src/app/(authenticated)/recipes/loading.tsx
  - src/app/layout.tsx
  - src/app/page.tsx
  - src/components/header.tsx
autonomous: false

must_haves:
  truths:
    - "User can register with email and password"
    - "User can log in with email and password"
    - "User stays logged in across page refreshes (session persists)"
    - "User can log out from any page via header button"
    - "Unauthenticated users are redirected to /auth"
    - "Already-authenticated users visiting /auth are redirected to /"
  artifacts:
    - path: "src/app/auth/page.tsx"
      provides: "Auth page with Login/Register tabs"
      min_lines: 20
    - path: "src/components/auth/login-form.tsx"
      provides: "Email + password login form"
      contains: "authClient.signIn"
    - path: "src/components/auth/register-form.tsx"
      provides: "Email + password registration form"
      contains: "authClient.signUp"
    - path: "src/app/(authenticated)/layout.tsx"
      provides: "Server-side session check, redirect to /auth if no session"
      contains: "auth.api.getSession"
    - path: "src/components/header.tsx"
      provides: "App header with user info and logout button"
      contains: "authClient.signOut"
  key_links:
    - from: "src/components/auth/login-form.tsx"
      to: "src/lib/auth-client.ts"
      via: "authClient.signIn.email"
      pattern: "signIn\\.email"
    - from: "src/components/auth/register-form.tsx"
      to: "src/lib/auth-client.ts"
      via: "authClient.signUp.email"
      pattern: "signUp\\.email"
    - from: "src/app/(authenticated)/layout.tsx"
      to: "src/lib/auth.ts"
      via: "auth.api.getSession"
      pattern: "getSession"
---

<objective>
Build the auth UI: /auth page with Login/Register tabs, route protection via (authenticated) layout group, and logout in header.

Purpose: Users can create accounts and log in. All app pages require authentication. Covers PROF-01, PROF-02, PROF-03.
Output: Working auth flow — register, login, session persistence, logout, route protection.
</objective>

<execution_context>
@/Users/jimmydore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jimmydore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-authentication-user-profile/04-RESEARCH.md
@.planning/phases/04-authentication-user-profile/04-CONTEXT.md
@.planning/phases/04-authentication-user-profile/04-01-SUMMARY.md
@src/lib/auth.ts
@src/lib/auth-client.ts
@src/app/layout.tsx
@src/app/page.tsx
@src/app/recipes/page.tsx
@src/app/recipes/[id]/page.tsx
@src/app/recipes/[id]/not-found.tsx
@src/app/recipes/[id]/loading.tsx
@src/app/recipes/loading.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Auth page with Login/Register forms</name>
  <files>
    src/app/auth/page.tsx
    src/components/auth/login-form.tsx
    src/components/auth/register-form.tsx
  </files>
  <action>
**1. Create `src/components/auth/login-form.tsx`:**
- Client component ("use client")
- Uses react-hook-form with Zod resolver
- Fields: email (type="email", required), password (type="password", required, min 8 chars)
- Calls `authClient.signIn.email({ email, password })` on submit
- Shows error message on failure (invalid credentials)
- Redirects to "/" on success via `router.push("/")`
- Uses shadcn/ui Form, Input, Button, Label components
- Loading state on submit button

**2. Create `src/components/auth/register-form.tsx`:**
- Client component ("use client")
- Fields: email, password (min 8), confirm password
- Validates password match client-side
- Calls `authClient.signUp.email({ email, password, name: email.split("@")[0] })` on submit
- Shows error on failure (email already taken)
- On success, auto-login by calling signIn.email, then redirect to "/"
- Uses same shadcn/ui components as login form

**3. Create `src/app/auth/page.tsx`:**
- Server component that checks session — if authenticated, redirect to "/"
- Uses shadcn Tabs component with two tabs: "Connexion" and "Inscription"
- Default tab: "Connexion" (login)
- Centered on page, max-w-md, card-style container
- App title "Meal Prep" above the form
- French labels throughout (Connexion, Inscription, Email, Mot de passe, Confirmer le mot de passe, Se connecter, Creer un compte)

**Auth page check:** The /auth page must check session server-side:
```typescript
import { auth } from "@/lib/auth";
import { headers } from "next/headers";
import { redirect } from "next/navigation";

const session = await auth.api.getSession({ headers: await headers() });
if (session) redirect("/");
```
  </action>
  <verify>`pnpm build` succeeds. Navigate to `/auth` — tabs render. Submit register form with test email — account created. Submit login form — logs in and redirects.</verify>
  <done>Auth page renders with Login/Register tabs. Registration creates account. Login authenticates and redirects. Already-authenticated users redirect away from /auth.</done>
</task>

<task type="auto">
  <name>Task 2: Authenticated route group + header with logout + move recipes</name>
  <files>
    src/app/(authenticated)/layout.tsx
    src/app/(authenticated)/recipes/page.tsx
    src/app/(authenticated)/recipes/[id]/page.tsx
    src/app/(authenticated)/recipes/[id]/not-found.tsx
    src/app/(authenticated)/recipes/[id]/loading.tsx
    src/app/(authenticated)/recipes/loading.tsx
    src/app/layout.tsx
    src/app/page.tsx
    src/components/header.tsx
  </files>
  <action>
**1. Create `src/app/(authenticated)/layout.tsx`:**
- Server component
- Checks session via `auth.api.getSession({ headers: await headers() })`
- If no session, `redirect("/auth")`
- If session exists, renders children + Header component
- Passes user info (email, name) to Header via props or context

**2. Create `src/components/header.tsx`:**
- Client component ("use client")
- Displays app name "Meal Prep" (links to /)
- Right side: user email/name + logout button
- Logout calls `authClient.signOut()` then `router.push("/auth")`
- Use shadcn Button (variant="ghost" for logout), Avatar for user icon
- Responsive: on mobile, just avatar + dropdown with logout

**3. Move recipe pages into (authenticated) route group:**
- Move `src/app/recipes/page.tsx` -> `src/app/(authenticated)/recipes/page.tsx`
- Move `src/app/recipes/[id]/page.tsx` -> `src/app/(authenticated)/recipes/[id]/page.tsx`
- Move `src/app/recipes/[id]/not-found.tsx` -> `src/app/(authenticated)/recipes/[id]/not-found.tsx`
- Move `src/app/recipes/[id]/loading.tsx` -> `src/app/(authenticated)/recipes/[id]/loading.tsx`
- Move `src/app/recipes/loading.tsx` -> `src/app/(authenticated)/recipes/loading.tsx`
- Delete old `src/app/recipes/` directory after moving

**IMPORTANT:** The moved files should NOT need import path changes since they use `@/` aliases. Verify all imports still resolve.

**4. Update `src/app/page.tsx`:**
- Keep the redirect to `/recipes` — this still works because the URL path is /recipes (route groups don't affect URLs)

**5. Update `src/app/layout.tsx`:**
- Keep existing layout but ensure body wraps children properly
- The Header is in (authenticated)/layout.tsx, NOT in root layout, so /auth page has no header
  </action>
  <verify>
1. `pnpm build` succeeds
2. Navigate to `/recipes` without session — redirects to `/auth`
3. Log in — redirects to `/`, which redirects to `/recipes` — recipes page renders with header
4. Click logout in header — redirects to `/auth`
5. Recipe detail pages still work at `/recipes/[id]`
  </verify>
  <done>All app pages protected by (authenticated) layout. Header shows on all authenticated pages with logout button. Recipe pages work at same URLs. Unauthenticated access redirects to /auth.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete auth flow: register, login, session persistence, logout, route protection. /auth page with French-labeled Login/Register tabs. All pages behind authentication. Header with logout.</what-built>
  <how-to-verify>
1. Open http://localhost:3000 — should redirect to /auth
2. Click "Inscription" tab, register with a test email (test@test.com / password123)
3. After registration, should auto-login and redirect to /recipes
4. Header should show user info and logout button
5. Refresh page — should stay logged in (session persists)
6. Click logout — should redirect to /auth
7. Try accessing /recipes directly — should redirect to /auth
8. Log back in — should work with the credentials created
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- Registration creates account and auto-logs in
- Login with valid credentials succeeds
- Session persists across page refresh
- Logout works from header
- All /recipes/* routes require authentication
- /auth redirects to / if already logged in
</verification>

<success_criteria>
PROF-01 (create account), PROF-02 (login + session persistence), PROF-03 (logout) are fully working. All pages require authentication. French-labeled auth UI.
</success_criteria>

<output>
After completion, create `.planning/phases/04-authentication-user-profile/04-02-SUMMARY.md`
</output>
