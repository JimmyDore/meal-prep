---
phase: 04-authentication-user-profile
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/auth.ts
  - src/lib/auth-client.ts
  - src/lib/env.ts
  - src/db/schema/auth.ts
  - src/db/schema/index.ts
  - src/app/api/auth/[...all]/route.ts
  - proxy.ts
  - .env
autonomous: true

must_haves:
  truths:
    - "Better Auth server responds to auth API requests at /api/auth/*"
    - "proxy.ts redirects unauthenticated requests to /auth"
    - "Auth schema tables (user, session, account, verification) exist in Postgres"
  artifacts:
    - path: "src/lib/auth.ts"
      provides: "Better Auth server configuration with Drizzle adapter"
      exports: ["auth"]
    - path: "src/lib/auth-client.ts"
      provides: "Better Auth client instance for React components"
      exports: ["authClient"]
    - path: "src/db/schema/auth.ts"
      provides: "Better Auth database tables (user, session, account, verification)"
      contains: "pgTable"
    - path: "src/app/api/auth/[...all]/route.ts"
      provides: "Next.js API route handler for all Better Auth endpoints"
      exports: ["GET", "POST"]
    - path: "proxy.ts"
      provides: "Optimistic cookie check for route protection"
      exports: ["proxy"]
  key_links:
    - from: "src/app/api/auth/[...all]/route.ts"
      to: "src/lib/auth.ts"
      via: "toNextJsHandler"
      pattern: "auth\\.handler"
    - from: "src/lib/auth.ts"
      to: "src/db/index.ts"
      via: "drizzleAdapter"
      pattern: "drizzleAdapter.*db"
    - from: "proxy.ts"
      to: "better-auth/cookies"
      via: "getSessionCookie"
      pattern: "getSessionCookie"
---

<objective>
Set up Better Auth with Drizzle adapter, create auth schema, API route handler, and proxy.ts for route protection.

Purpose: Foundation for all authentication — without this, no login/register/session management is possible.
Output: Working Better Auth backend that responds to /api/auth/* and a proxy.ts that protects routes.
</objective>

<execution_context>
@/Users/jimmydore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jimmydore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-authentication-user-profile/04-RESEARCH.md
@.planning/phases/04-authentication-user-profile/04-CONTEXT.md
@src/db/index.ts
@src/db/schema/index.ts
@src/db/schema/common.ts
@src/lib/env.ts
@package.json
@next.config.ts
@drizzle.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and add shadcn/ui components</name>
  <files>package.json</files>
  <action>
Install Better Auth and form libraries:
```bash
pnpm add better-auth react-hook-form @hookform/resolvers
```

Add shadcn/ui components needed for auth and profile forms:
```bash
pnpm dlx shadcn@latest add form label select radio-group tabs avatar dropdown-menu
```

These components are used across Plans 02-04 (auth UI, onboarding wizard). Installing them all now avoids repeated installs.
  </action>
  <verify>`pnpm build` compiles without errors. Check `node_modules/better-auth` exists. Check `src/components/ui/form.tsx`, `src/components/ui/tabs.tsx`, `src/components/ui/avatar.tsx` exist.</verify>
  <done>better-auth, react-hook-form, @hookform/resolvers in dependencies. All 7 shadcn/ui components installed.</done>
</task>

<task type="auto">
  <name>Task 2: Configure Better Auth server + client + schema + API route + proxy</name>
  <files>
    src/lib/auth.ts
    src/lib/auth-client.ts
    src/lib/env.ts
    src/db/schema/auth.ts
    src/db/schema/index.ts
    src/app/api/auth/[...all]/route.ts
    proxy.ts
    .env
  </files>
  <action>
**1. Add env vars to `.env`:**
- `BETTER_AUTH_SECRET` — generate with `openssl rand -hex 32`
- `NEXT_PUBLIC_APP_URL=http://localhost:3000`

**2. Update `src/lib/env.ts`:**
- Add `BETTER_AUTH_SECRET: z.string().min(32)` to server vars
- Add `NEXT_PUBLIC_APP_URL: z.string().url()` to client vars
- Add both to runtimeEnv

**3. Create `src/lib/auth.ts`** — Better Auth server config:
```typescript
import { betterAuth } from "better-auth";
import { nextCookies } from "better-auth/next-js";
import { drizzleAdapter } from "better-auth/adapters/drizzle";
import { db } from "@/db";

export const auth = betterAuth({
  database: drizzleAdapter(db, { provider: "pg" }),
  emailAndPassword: {
    enabled: true,
    minPasswordLength: 8,
    maxPasswordLength: 128,
  },
  session: {
    expiresIn: 60 * 60 * 24 * 30, // 30 days
    updateAge: 60 * 60 * 24,       // Renew daily
    cookieCache: {
      enabled: true,
      maxAge: 5 * 60, // 5-min cache
    },
  },
  plugins: [nextCookies()],
});
```

**4. Create `src/lib/auth-client.ts`** — Client instance:
```typescript
import { createAuthClient } from "better-auth/react";

export const authClient = createAuthClient({
  baseURL: process.env.NEXT_PUBLIC_APP_URL || "http://localhost:3000",
});
```

**5. Generate auth schema** — Run the Better Auth CLI to generate Drizzle schema:
```bash
pnpm dlx better-auth generate --config src/lib/auth.ts --output src/db/schema/auth.ts
```
If the CLI fails or produces incompatible output, manually create `src/db/schema/auth.ts` with the 4 Better Auth tables (user, session, account, verification) using the project's existing `idColumn` and `timestamps` patterns from `common.ts`. Use `text()` for Better Auth IDs (not uuid) as Better Auth generates its own IDs.

**Important:** Better Auth expects specific column names. The schema file must match Better Auth's expectations. Check Better Auth docs for required columns.

**6. Update `src/db/schema/index.ts`:**
Add `export * from "./auth";`

**7. Create `src/app/api/auth/[...all]/route.ts`:**
```typescript
import { auth } from "@/lib/auth";
import { toNextJsHandler } from "better-auth/next-js";

export const { GET, POST } = toNextJsHandler(auth.handler);
```

**8. Create `proxy.ts` at project root** — optimistic cookie check:
```typescript
import { getSessionCookie } from "better-auth/cookies";
import { NextResponse } from "next/server";
import type { NextRequest } from "next/server";

export function proxy(request: NextRequest) {
  const { pathname } = request.nextUrl;

  // Allow auth page, API routes, and static assets
  if (pathname.startsWith("/auth") || pathname.startsWith("/api/") || pathname.startsWith("/_next/")) {
    return NextResponse.next();
  }

  const sessionCookie = getSessionCookie(request);
  if (!sessionCookie) {
    return NextResponse.redirect(new URL("/auth", request.url));
  }

  return NextResponse.next();
}

export const config = {
  matcher: ["/((?!_next/static|_next/image|favicon.ico|.*\\.png$).*)"],
};
```

**IMPORTANT:** Next.js 16 uses `proxy.ts` (not `middleware.ts`). If proxy.ts does not work at project root, try `src/proxy.ts`. Verify by running `pnpm dev` and checking redirect behavior. If Next.js 16.1.6 still uses middleware.ts, name the file `middleware.ts` instead and export the function as `middleware` instead of `proxy`.

**9. Push schema to dev DB:**
```bash
pnpm db:push
```

Verify the tables exist:
```bash
docker compose exec -T db psql -U mealprep -d mealprep -c "\dt"
```
Should show user, session, account, verification tables alongside existing recipes/ingredients/tags tables.
  </action>
  <verify>
1. `pnpm build` succeeds
2. `docker compose exec -T db psql -U mealprep -d mealprep -c "\dt"` shows user, session, account, verification tables
3. `pnpm dev` starts, `curl -s http://localhost:3000/api/auth/ok` returns a response (Better Auth health check)
4. Navigating to `http://localhost:3000/recipes` in browser redirects to `/auth` (proxy.ts working)
  </verify>
  <done>Better Auth server configured with Drizzle adapter, 4 auth tables in Postgres, API handler at /api/auth/[...all], proxy.ts redirects unauthenticated users to /auth, BETTER_AUTH_SECRET and NEXT_PUBLIC_APP_URL in env.</done>
</task>

</tasks>

<verification>
- `pnpm build` passes without type errors
- Auth tables exist in dev Postgres
- `/api/auth/ok` or similar Better Auth endpoint responds
- Unauthenticated request to `/recipes` redirects to `/auth`
</verification>

<success_criteria>
Better Auth is fully configured and auth tables exist in the database. The API route handler is mounted. proxy.ts protects all routes except /auth and /api/*. The env vars BETTER_AUTH_SECRET and NEXT_PUBLIC_APP_URL are configured.
</success_criteria>

<output>
After completion, create `.planning/phases/04-authentication-user-profile/04-01-SUMMARY.md`
</output>
